# @yaya/director-uni

## Project setup

```
yarn install
```

### 微信小程序调试

微信小程序支持有限，请务必优先在微信小程序中开发

```
npm run dev:mp-weixin
```

- `yaya-director` 导演基类组件
- `yaya-scene` 场景基类组件
- `yaya-scene-quiz` 基于场景基类实现的，选择题的简单示例

#### 命名规范

- 场景命名 `yaya-scene-*`

#### 开始开发

1. 创建你的测试页面。参照`pages/complex-example`或`pages/single-example`，创建一个测试页面
   - 不要用别人测试页面，以免冲突
   - 还需要添加 pages.json 配置
2. 创建你的场景。参照`components/yaya-scene-quiz`，创建一个场景
3. 在`components/yaya-director`中增加你的场景的分支判断，扩展新的场景
4. 根据你的场景，修改、构造测试数据 `pages/your-example/data.js`
5. 在你的测试页面进行调试
6. 在小程序中开发调试
   - `npm run dev:mp-weixin`

** 分支规范 **

- `master`分支仅用于发布，请勿随意修改；
- `dev`是共享主开发分支，个人开发调试请新增`feature-*`分支，避免有问题的代码影响、阻塞其他人

** 注意事项 **

- 目前只简单实现了`director`和`scene`，有不能满足场景内功能的情况或接口需求，可以及时抛出来
- `scene`应该是通用的，请勿耦合业务逻辑，请考虑通用性
- `scene`后续原则上都是可以被任意组合串联的，请考虑通用性
- 鉴于开发调试效率，暂时在本项目的小程序中进行开发
- 由于`uniapp`编译较为特殊，组件在小程序上有二次处理和交叉处理的行为，不能用vue原生的组件编译方式进行编译，也不支持Vue.use的方式引入，并没有使用原生vue组件的项目模板；同时也无法使用ts开发；参考`uni-ui`项目的build方式直接产出component的“源文件”，供主项目编译使用。暂无更好的解决方式
- 目前仍处于开发初期，相关设计和机制可能不完善，有问题请及时抛出讨论

### 相关设计

场景切换示例图：

![场景切换示例图](docs/2020-03-23-08-24-33.png)

Director、场景抽象：

![Director、场景抽象](docs/2020-03-23-08-26-22.png)

整体设计：

![整体设计](docs/2020-03-23-08-27-11.png)

核心数据接口：

```typescript
type SceneID = string;

/**
 * 脚本数据配置
 * 包含所有场景信息和剧本启动信息
 */
interface ScriptData {
  // 初始场景
  startScene: {
    id: SceneID;
    payload: any;
  };
  // 场景池
  scenes: Array<SceneData>;
}

/**
 * 场景数据
 */
interface SceneData {
  // 场景ID
  id: SceneID;
  // 场景元素 后续需求
  elements: Array<any>;
  ext: any;
  actions: {
    // 场景结束行为
    complete: SceneActionData;
    [actionName: string]: SceneActionData;
  };
}

/**
 * 场景行为数据
 */
interface SceneActionData {
  // 行为类型：替代当前场景、新增进入场景栈、销毁
  type: "replace" | "push" | "destroy";
  // 目标场景值
  target: SceneID;
  // 场景入参
  payload: any;
}

/**
 * example: 视频场景数据
 */
interface VideoSceneData extends SceneData {
  // 视频地址
  url: string;
  // 视频长度
  length: number;
  // 视频热点
  hotSpots: Array<VideoSceneHotSpot>;
  // 行为
  actions: {
    complete: SceneActionData;
    [actionName: string]: SceneActionData;
  };
}

/**
 * 视频热点
 */
interface VideoSceneHotSpot {
  // 热点时间戳
  timestamp: number;
  // 热点行为
  action: SceneActionData;
}

/**
 * example: 练习场景数据
 */
interface PraticesSceneData extends SceneData {
  // 扩展字段，类比原来的components数据
  ext: {
    questionList?: Array<{
      tid: string;
      content: string;
      actions: {
        // 正确回答行为
        success?: SceneActionData;
        // 错误回答行为
        fail?: SceneActionData;
        // 结束行为
        complete?: SceneActionData;
        [actionName: string]: SceneActionData;
      };
    }>;
  };
  actions: {
    // 正确回答行为
    success?: SceneActionData;
    // 错误回答行为
    fail?: SceneActionData;
    // 结束行为
    complete?: SceneActionData;
    [actionName: string]: SceneActionData;
  };
}

/**
 * example： cocos游戏场景数据
 */
interface GameSceneData extends SceneData {
  templateID: string;
  templateType: string;
  data: any;
  actionMap: Map<string, SceneActionData>;
}
```

### Compiles and hot-reloads for development

```
yarn serve
```

### Compiles and minifies for production

```
yarn build
```

### Customize configuration

See [Configuration Reference](https://cli.vuejs.org/config/).


### audioSdk使用实例
  - audioText 必须,类型:string||array
  对1-3类型为朗读英文文本， 对4类型为所有可能的问题回答（数组）， 对5类型为参考复述文本， 6 类型为音标
  - audioType  必须,类型:number,
  评分类型 1 单词；2 句子； 3 段落； 4 问题回答； 5 复述;  6 音标 
## method
  - `start(cb)` 开始录音, cb可选,
  - `stop(cb)` 结束录音, cb可选,
  - `pause(cb)` 暂停录音, cb可选,
  - `resume({obj})` 继续录音, obj可选,{audioText(可选),audioType(可选)}
  - `onResult(cb)` 返回结果,
  - `onError(cb)` 评测错误处理,
  - `playBack()` 播放录音,
  - `stopPlayBack()` 停止播放录音,
```

  const vSdk = new voiceSdk({
    audioText: 'hello',
    audioType: 1
  })
  vSdk.start();
  vSdk.stop();
  vSdk.onResult((res)=>{
    console.log(666666666666);
    console.log(res);
    Toast(res.score);
  })
  vSdk.onError(()=>{
    console.log("errorerrorerrorerror");
  })
  vSdk.playBack();
  vSdk.stopPlayBack();
```
