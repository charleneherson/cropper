<template>
  <view class="director" id="director" @click="zsTracker">
    <view v-if="showBackBtn" id="back-btn" class="back-btn" @tap="onBackTap">
    </view>
    <yayaGold v-if="formatRaw" :totalGoldCount="formatRaw.origin.credit" />
    <uoLoadFiles v-if="resoursesLoaded" />
    <yayaGatherWord
      v-if="isShowGatherWord"
      :common="common"
      :isShowGatherWord="isShowGatherWord"
      @gatherWordResult="gatherWordResult"
    ></yayaGatherWord>
    <yayaResult
      v-if="isShowAwardResult"
      :isShowAwardResult="isShowAwardResult"
      @animationResult="animationResult"
    ></yayaResult>
    <view class="sence-change" v-if="showShade">
      <div class="change-container" :class="{ flower_play: showShade }">
        <image
          src="https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-common/rainbow-move.png"
        />
      </div>
    </view>
    <swiper
      class="swiper"
      v-if="director && resoursesLoaded"
      :autoplay="false"
      :current="currentSceneIndex"
      @animationfinish="animationfinish"
    >
      <swiper-item
        class="swiper-item"
        v-for="scene in director.sceneQueue"
        :key="scene.id"
        catchtouchmove="stopTouchMove"
      >
        <yaya-scene
          class="scene-wrap"
          :key="scene.id"
          v-if="scene.type === 'basic'"
          :raw="scene"
          @act="onAct"
          @interact="onInteract"
        ></yaya-scene>
        <yaya-scene-quiz
          class="scene-wrap"
          :key="scene.id"
          v-if="scene.type === 'quiz'"
          :raw="scene"
          @act="onAct"
          @interact="onInteract"
        ></yaya-scene-quiz>
        <yaya-scene-video
          class="scene-wrap"
          :key="scene.id"
          v-if="scene.type === 'video'"
          :raw="scene"
          @act="onAct"
          @interact="onInteract"
        ></yaya-scene-video>
        <yaya-scene-choice
          class="scene-wrap"
          :key="scene.id"
          v-if="scene.type === 'choice'"
          :raw="scene"
          @act="onAct"
          @interact="onInteract"
        ></yaya-scene-choice>
        <yaya-scene-write
          class="scene-wrap"
          :key="scene.id"
          v-if="scene.type === 'write'"
          :raw="scene"
          @act="onAct"
          @interact="onInteract"
        ></yaya-scene-write>
        <!-- 在此扩展新的场景 -->
        <yayaSceneQuizInClass
          class="scene-wrap"
          :key="scene.id"
          v-if="scene.type === 'quizInClass'"
          :raw="scene"
          @act="onAct"
          @interact="onInteract"
        />
      </swiper-item>
    </swiper>
    <yaya-loading-page
      v-if="!resoursesLoaded"
      id="loding-page"
      title="加载中"
      :audioSrc="''"
      :moduleImg="moduleImage"
      :resourses="resourses"
      @loadDone="loadDone"
    ></yaya-loading-page>
    <yaya-interception-page
      v-if="interceptionType"
      :msgType="interceptionType"
      @again="onAgain"
      @back="onBack"
      @continue="onContinue"
      @next="onNext"
      @cancel="onCancel"
    ></yaya-interception-page>
  </view>
</template>
<script>
import { director } from "./director";
import { formatData } from "./formatData";
import yayaLoadingPage from "../yaya-common/yaya-loading-page.vue";
import uoLoadFiles from "../yaya-common/up-load-files";
import yayaInterceptionPage from "../yaya-common/yaya-interception-page.vue";
import yayaScene from "../yaya-scene/yaya-scene.vue";
import yayaSceneQuiz from "../yaya-scene-quiz/yaya-scene-quiz.vue";
import yayaSceneQuizInClass from "../yaya-scene-quiz-in-class/index.vue";
import yayaSceneChoice from "../yaya-scene-choice/yaya-scene-choice.vue";
import yayaSceneWrite from "../yaya-scene-write/yaya-scene-write.vue";
import yayaSceneVideo from "../yaya-scene-video/yaya-scene-video.vue";
import { mapState, mapMutations } from "vuex";
import yayaResult from "../yaya-common/components/yaya-result/index";
import yayaGatherWord from "../yaya-common/components/yaya-gather-word/index";
import yayaGold from "../yaya-common/yaya-gold";
export const YayaDirectorEventType = {
  BackTapped: "backTapped",
  Finished: "finished",
  SceneAct: "sceneAct",
  SceneInteract: "sceneInteract",
  Back: "back",
  Again: "again",
  Continue: "continue",
  Next: "next",
};
export const directorCtrl = director;

/**
 * Director组件
 */
export default {
  name: "yayaDirector",
  components: {
    yayaLoadingPage,
    yayaInterceptionPage,
    yayaScene,
    yayaSceneQuiz,
    yayaSceneQuizInClass,
    yayaSceneChoice,
    yayaSceneWrite,
    yayaSceneVideo,
    yayaResult,
    yayaGold,
    uoLoadFiles,
    yayaGatherWord,
  },
  props: {
    raw: {
      type: Object,
      default: {},
    },
    // 默认都做raw的格式转换，在本地项目中用测试数据的话可以设置不转换
    needFormat: {
      type: Boolean,
      default: true,
    },
  },
  computed: {
    ...mapState("yayaCommon", ["AWARD_EXT"]),
  },
  data() {
    this.dirctorAudioContext = uni.createInnerAudioContext();
    return {
      data: {},
      resourses: [],
      resoursesLoaded: false,
      director: null,
      showBackBtn: true,
      interceptionType: "",
      formatRaw: null,
      currentSceneIndex: 0,
      rMap: null,
      showShade: false,
      isShowAwardResult: false, //展示结算
      isShowGatherWord: false, //展示常见字
      common: [], //常见字的数据
      commonflag: false, //是否常见字已学习
    };
  },
  mounted() {
    if (this.needFormat) {
      this.formatRaw = formatData(this.raw);
    } else {
      this.formatRaw = this.raw;
    }
    // this.updateGoldCount(this.formatRaw.origin.credit);
    // console.log("this.formatRawformatRawformatRawformatRawformatRaw");
    // console.log(JSON.stringify(this.formatRaw));
    // // 资源预加载
    console.log("资源加载开始");
    // const regexURL = /^(https?):\/\/([\w\-]+(\.[\w\-]+)*\/)*[\w\-]+(\.[\w\-]+)*\/?(\?([\w\-\.,@?^=%&:\/~\+#]*)+)?/g;
    const regex = /https?:\/\/([\w\-]+(\.[\w\-]+)*\/)*[\w\%\-\.]+(\.(jpeg|jpg|mp3|png)+)/g;
    this.resourses = [...new Set(JSON.stringify(this.raw).match(regex))] || [];
    if (this.resourses.length === 0) {
      this.resoursesLoaded = true;
      this.initDirector(this.formatRaw);
    }
    wx.ttt = this;
  },
  beforeUpdate() {},
  destroyed() {
    director.destroy();
  },
  methods: {
    ...mapMutations("yayaCommon", [
      "updateGoldCount",
      "addGoldCount",
      "updateSystem",
      "updateIsPad",
      "updateCoreStudied",
      "updateWordswitch",
    ]),
    animationend() {
      this.showGoldAnimation = false;
      this.addGoldCount(this.AWARD_EXT.credit);
    },
    initDirector(raw) {
      this.getsysTem();
      this.director = director;
      director.init(raw, this.$nextTick.bind(this));
      director.start();
      // 更新字体卡已学汉字
      console.log(" 更新字体卡已学汉字", raw.origin);
      this.updateCoreStudied(raw.origin.coreStudied);
      this.updateWordswitch(raw.origin.wordswitch);
      this.commonflag = raw.origin.commonflag;
      let wordswitch = Boolean(raw.origin.wordswitch); //写死开关
      // let wordswitch = true;

      director.on("finished", (payload) => {
        this.showShade = false;
        //判断是否有常见字收集
        if (
          wordswitch &&
          !this.commonflag &&
          [12, 13, 14].includes(raw.origin.nextModuleType) &&
          raw.origin.common.length !== 0
        ) {
          this.isShowGatherWord = true;
          this.common = raw.origin.common;
        } else {
          this.handleResultStatus();
        }
      });
      wx.dddd = this;
    },
    handleResultStatus() {
      //展现结算动画
      if (this.AWARD_EXT.module_reward > 0) {
        setTimeout(() => {
          this.isShowAwardResult = true;
        }, 500);
      } else {
        this.moduleFinish();
      }
    },
    loadDone(resMap) {
      // 替换远程资源为本地资源
      let rawStr = JSON.stringify(this.formatRaw);
      this.rMap = JSON.parse(JSON.stringify(resMap));
      for (const key in resMap) {
        if (resMap.hasOwnProperty(key)) {
          const url = resMap[key];
          rawStr = rawStr.replace(new RegExp(key, "gm"), url);
        }
      }
      this.resoursesLoaded = true;
      this.initDirector(JSON.parse(rawStr));
    },
    onBackTap(e) {
      if (this.resoursesLoaded) {
        this.interceptionType = "leave";
        this.director.currentScene &&
          this.director.currentScene.pause({
            isIntercepted: true,
          });
        this.showBackBtn = false;
      } else {
        this.$emit("back", e);
      }
    },
    onBack(e) {
      this.$emit(YayaDirectorEventType.Back, e);
    },
    onAgain(e) {
      this.interceptionType = "";
      this.showBackBtn = true;
      director.destroy();
      this.currentSceneIndex = 0;
      this.showShade = false;
      this.$nextTick(() => {
        this.initDirector(this.formatRaw);
        this.$emit(YayaDirectorEventType.Again, e);
      });
    },
    onContinue(e) {
      this.interceptionType = "";
      this.showBackBtn = true;
      this.director.currentScene &&
        this.director.currentScene.resume({
          isIntercepted: false,
        });
      this.$emit(YayaDirectorEventType.Continue, e);
    },
    onNext(e) {
      this.$emit(YayaDirectorEventType.Next, e);
    },
    onAct(action) {
      console.log("Director OnAct", action);
      this.director.doAction(action, this.$nextTick.bind(this));
      this.$emit(YayaDirectorEventType.SceneAct, {
        action,
      });
      if (action.type !== "destroy") {
        this.showShade = true;
      }
      this.$nextTick(() => {
        setTimeout(() => {
          this.currentSceneIndex = this.director.getCurrentSceneIndex();
        }, 500);
      });
    },
    onInteract(payload) {
      // 反向替换微信本地资源地址成remote地址
      if (this.rMap) {
        let payloadStr = JSON.stringify(payload);
        let resMap = this.rMap;
        for (const key in resMap) {
          if (resMap.hasOwnProperty(key)) {
            const url = resMap[key];
            payloadStr = payloadStr.replace(new RegExp(url, "gm"), key);
          }
        }
        payload = JSON.parse(payloadStr);
      }
      console.log("Director onInteract", payload);
      this.$emit(YayaDirectorEventType.SceneInteract, {
        ...payload,
      });
    },
    devNext() {
      this.director.next();
    },
    devPush() {},
    onCancel() {
      this.showBackBtn = true;
      this.$emit("back");
    },
    stopTouchMove() {
      return;
    },
    animationfinish() {
      this.$nextTick(() => {
        // 转场
        setTimeout(() => {
          this.showShade = false;
        }, 600);
      });
    },
    // 结算动画结束
    animationResult() {
      setTimeout(() => {
        this.showShade = true;
        setTimeout(() => {
          this.isShowAwardResult = false;
          this.showShade = false;
          this.moduleFinish();
        }, 1000);
      }, 2000);
    },
    // 收集字词卡结束
    gatherWordResult() {
      let common = this.common;
      let words = common && common.join(",");
      //提交数据切换场景
      let params = {
        type: "scenePost",
        data: {
          data: {
            type: 2,
            word: words,
          },
          type: "wordcardgather",
        },
      };
      this.onInteract(params);
      this.isShowGatherWord = false;
      this.handleResultStatus();
    },

    moduleFinish() {
      const raw = this.formatRaw;
      let type = "finish";
      if (!raw.origin.nextModuleType) {
        type = "allFinishNoReport";
      }
      if ([12, 13, 14].includes(raw.origin.nextModuleType)) {
        type = "allFinish";
      }
      this.interceptionType = type;
      this.$emit("finished");
    },
    getsysTem() {
      console.log("getsysTemgetsysTem");
      wx.getSystemInfo({
        success: (res) => {
          const isIpad = /iPad/.test(res.model);
          console.log("isIpadisIpadisIpadisIpadisIpadisIpadisIpadisIpad");
          console.log(isIpad);
          this.updateSystem(res.system);
          this.updateIsPad(isIpad);
        },
        fail: (err) => {
          console.log(err);
        },
      });
    },
  },
};
</script>
<style lang="scss" scoped>
@function toVmin($rpx) {
  @return #{$rpx * 100 / 750}vmin;
}
.director {
  width: 100vw;
  height: 100vh;
  .back-btn {
    width: toVmin(64);
    height: toVmin(64);
    position: absolute;
    left: toVmin(40);
    top: toVmin(32);
    z-index: 10;
    background: url("../static/back-btn-2x.png");
    background-size: 100% 100%;
  }
  .sence-change {
    width: 100vw;
    background: rgba(0, 0, 0, 0);
    position: fixed;
    left: 0;
    top: 0;
    z-index: 200;
    display: flex;
    align-items: center;
    .change-container {
      padding-left: 100vw;
      &.flower_play {
        animation: rainbow_move 0.6s linear 1;
        animation-fill-mode: forwards;
      }
      image {
        margin: 0 auto;
        width: 170vw;
        height: 100vh;
      }
    }
  }
  .scene-wrap {
    position: absolute;
    width: 100vw;
    height: 100vh;
    left: 0px;
    top: 0px;
  }
  // deep 不生效？
  /deep/ .scene {
    position: absolute;
    width: 100vw;
    height: 100vh;
  }
  .swiper {
    width: 100vw;
    height: 100vh;
    position: absolute;
    .swiper-item {
      width: 100vw;
      height: 100vh;
    }
  }
}
@keyframes rainbow_move {
  0% {
    transform: translateX(-2%); /**左移元素**/
  }
  50% {
    transform: translateX(-30%); /**左移元素**/
  }
  100% {
    transform: translateX(-62%); /**左移元素**/
  }
}
</style>
