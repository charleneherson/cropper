<template>
  <view class="loading-container">
    <view class="bg_left"></view>
    <view class="bg_right"></view>
    <view class="link-img">
      <image
        src="https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-common/loading_page.gif"
        class="img"
        mode="aspectFill"
      />
    </view>
    <view class="yaya_jiasu">课程正在加载，耐心等待喔～</view>
    <!-- <view class="yaya_beta">Beta 版本加载慢请理解，下一版会更快喔~</view> -->
    <!-- <view class="title" :class="{rubberBand: isShowAnimate}">{{ title }}</view> -->
    <view class="progress-container" v-if="isShowProgress">
      <view class="progress-info">
        <view class="progress-left"></view>
        <!-- <view class="progress-left">{{ title }}...</view> -->
        <view class="progress-right">{{ percent }}%</view>
      </view>
      <yaya-progress :percent="percent"></yaya-progress>
    </view>
  </view>
</template>

<script>
import yayaProgress from "./yaya-progress.vue";

export default {
  name: "yaya-loading-page",
  data() {
    return {
      percent: 0,
      isAudioEnd: false,
      isShowAnimate: false
    };
  },
  components: {
    yayaProgress
  },
  props: {
    resourses: {
      type: Array,
      default: []
    },
    moduleImg: "",
    isShowProgress: {
      type: Boolean,
      default: true
    },
    title: {
      type: String,
      default: ""
    },
    audioSrc: {
      type: String,
      default: ""
    }
  },
  created() {
    if (!this.isShowProgress) {
      setTimeout(() => {
        this.$emit("loadDone");
      }, 2000);
    }
    this.isShowAnimate = true;
    if (this.audioSrc) {
      const audioCtx = wx.createInnerAudioContext();
      audioCtx.src = this.audioSrc;
      audioCtx.play();
      audioCtx.onEnded(() => {
        this.isAudioEnd = true;
      });
    } else {
      this.isAudioEnd = true;
    }
  },
  watch: {
    resourses(val) {
      if (val && val.length > 0) {
        this.downloadFile();
      } else {
        this.$emit("loadDone", fileCache);
      }
    }
  },
  methods: {
    downloadFile() {
      const file = this.resourses;
      const len = file.length;
      const that = this;
      const step = Math.ceil(100 / len);
      let percent = 0;
      const fileCache = {};
      let isFail = false;
      let downloadIndex = 0;
      console.log(len);
      if (len === 0) {
        this.$emit("loadDone", fileCache);
        return;
      }
      for (let i = 0; i < len; i++) {
        const downloadTask = wx.downloadFile({
          url: file[i],
          timeout: 120000,
          success(res) {
            if (res.statusCode === 200) {
              fileCache[file[i]] = res.tempFilePath;
              percent += step;
            } else {
              isFail = true;
            }
          },
          fail(error) {
            console.log(error);
            isFail = true;
          },
          complete() {
            downloadIndex += 1;
            if (percent >= 100) {
              percent = 100;
            }
            that.percent = percent;
            if (downloadIndex >= len) {
              if (isFail) {
                wx.showModal({
                  title: "",
                  content: "网络异常，进入失败",
                  cancelText: "退出",
                  confirmText: "重试",
                  showCancel: true,
                  success(res) {
                    if (res.confirm) {
                      that.downloadFile();
                    } else if (res.cancel) {
                      uni.navigateBack({
                        delta: 1
                      });
                    }
                  }
                });
                return;
              }
              if (that.isAudioEnd && that.audioSrc) {
                that.$emit("loadDone", fileCache);
                return;
              }
              setTimeout(() => {
                that.$emit("loadDone", fileCache);
              }, 1000);
            }
          }
        });
      }
    }
  }
};
</script>

<style scoped lang="scss">
@function tovmin($rpx) {
  @return #{$rpx * 100 / 750}vmin;
}
.loading-container {
  background-color: #fff7f0;
  width: 100%;
  height: 100%;
  padding-top: tovmin(138);
  box-sizing: border-box;
  position: relative;
  .bg_left {
    width: tovmin(626);
    height: tovmin(123);
    height: 100vh;
    position: absolute;
    left: 0;
    bottom: 0;
    background: url("https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-common/bg-left-2x.png")
      0 0 no-repeat;
    background-size: cover;
  }
  .bg_right {
    width: tovmin(490);
    height: tovmin(155);
    height: 100vh;
    position: absolute;
    right: 0;
    bottom: 0;
    background: url("https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-common/bg-right-2x.png")
      0 0 no-repeat;
    background-size: cover;
  }
}
.link-img {
  width: tovmin(380);
  height: tovmin(380);
  margin: 0 auto;
  overflow: hidden;
  margin-top: tovmin(10);
}
.yaya_jiasu {
  margin-top: tovmin(-30);
}
.yaya_beta {
  font-size: 3.4vmin;
  color: #999999;
  margin-top: 5px;
}
.link-img image {
  width: tovmin(300);
  height: tovmin(300);
  margin: 0 auto;
}
.progress-container {
  width: 96%;
  margin: 0 auto;
  margin-top: tovmin(90);
}
.title {
  font-size: tovmin(56);
  font-weight: bold;
  text-align: center;
  color: #2e2e2e;
}
.progress-left {
  float: left;
  font-size: tovmin(32);
}
.progress-info {
  overflow: hidden;
  width: 100%;
  color: #666666;
  margin-bottom: tovmin(6);
  display: flex;
  align-items: flex-end;
  justify-content: space-between;
  margin-top: tovmin(-40);
}
.progress-right {
  float: right;
  font-size: tovmin(32);
}
@keyframes rubberBand {
  from {
    -webkit-transform: scale3d(1, 1, 1);
    transform: scale3d(1, 1, 1);
  }

  30% {
    -webkit-transform: scale3d(1.25, 0.75, 1);
    transform: scale3d(1.25, 0.75, 1);
  }

  40% {
    -webkit-transform: scale3d(0.75, 1.25, 1);
    transform: scale3d(0.75, 1.25, 1);
  }

  50% {
    -webkit-transform: scale3d(1.15, 0.85, 1);
    transform: scale3d(1.15, 0.85, 1);
  }

  65% {
    -webkit-transform: scale3d(0.95, 1.05, 1);
    transform: scale3d(0.95, 1.05, 1);
  }

  75% {
    -webkit-transform: scale3d(1.05, 0.95, 1);
    transform: scale3d(1.05, 0.95, 1);
  }

  to {
    -webkit-transform: scale3d(1, 1, 1);
    transform: scale3d(1, 1, 1);
  }
}

.rubberBand {
  animation-name: rubberBand;
  animation-duration: 1s;
  animation-delay: 0;
  animation-iteration-count: 2;
}
</style>
