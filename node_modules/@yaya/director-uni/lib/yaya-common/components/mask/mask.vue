<template>
  <view class="mask" id="rights_many_times">
    <view
      v-if="audioType"
      :class="[audioType,
       {'liandui':isLiandui && !isLowPhone},
       {'no_liandui':!isLiandui  && !isLowPhone},
       {'liandui_gif':isLowPhone},
       ]"
      :style="{ 'background-image': 'url(' + imageUrl + ')' }" 
      @animationstart="animationstart(audioType)" 
      @animationend="animationend(audioType)">
    </view>
  </view>
</template>
<script>
const baseUrl = 'https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-common/fankui';
let urlStr = "https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-common/audio/";
const flash_map = {
  VoiceMap: {
      Full: baseUrl + "/noliandui/Full.mp3",
      Speaker: baseUrl + "/noliandui/Speaker.mp3",
      KeepTrying: baseUrl + "/noliandui/KeepTrying.mp3",
      NotBad: baseUrl + "/noliandui/NotBad.mp3",
      Wonderful: baseUrl + "/noliandui/Wonderful.mp3",
      VoiceFluent: baseUrl + "/noliandui/VoiceFluent.mp3",
      2: baseUrl + '/liandui/2.mp3',
      3: baseUrl + '/liandui/3.mp3',
      4: baseUrl + '/liandui/4.mp3',
      5: baseUrl + '/liandui/5.mp3',
      6: baseUrl + '/liandui/6.mp3',
      7: baseUrl + '/liandui/7.mp3',
      8: baseUrl + '/liandui/8.mp3',
      9: baseUrl + '/liandui/9.mp3'
  },
  no_liandui: {
    first: {
      reading: ['Full', 'VoiceFluent'],
      notReading: ['Wonderful','Speaker']
    },
    notFirst: {
      reading: ['KeepTrying','NotBad'],
      notReading: ['KeepTrying','NotBad']
    }
  },
  liandui: {
    2: baseUrl + '/liandui/2.png',
    3: baseUrl + '/liandui/3.png',
    4: baseUrl + '/liandui/4.png',
    5: baseUrl + '/liandui/5.png',
    6: baseUrl + '/liandui/6.png',
    7: baseUrl + '/liandui/7.png',
    8: baseUrl + '/liandui/8.png',
    9: baseUrl + '/liandui/9.png'
  },
  lianduiGif: {
    2: baseUrl + '/liandui/2.gif',
    3: baseUrl + '/liandui/3.gif',
    4: baseUrl + '/liandui/4.gif',
    5: baseUrl + '/liandui/5.gif',
    6: baseUrl + '/liandui/6.gif',
    7: baseUrl + '/liandui/7.gif',
    8: baseUrl + '/liandui/8.gif',
    9: baseUrl + '/liandui/9.gif'
  }
}
import { mapState, mapMutations } from "vuex";
export default {
  name: "optionList",
  props: {
    maskType: {
      type: [String, Array],
      default: '',
    },
  },
  data() {
    this.innerAudioContext = uni.createInnerAudioContext();
    return {
      isLiandui: false,
      audioEnd: false,
      animationEnd: false,
      emited: false,
      imageUrl: '',
      audioType: '',
      isLowPhone: false
    };
  },
  watch: {
    AWARD_EXT(val){
      if(val) {
        let type;
        this.isLiandui = (this.AWARD_EXT.cur_correct > 1);
        if(this.isLiandui) {
          this.audioType = this.AWARD_EXT.cur_correct >= 9 ? 9 : this.AWARD_EXT.cur_correct;
          type =  this.isLowPhone ? 'lianduiGif' : 'liandui';
        } else {
          type = 'no_liandui';
          if (Array.isArray(this.maskType)) {
            let list = flash_map[type][this.maskType[0]][this.maskType[1]];
            this.audioType = list[Math.floor(Math.random() * list.length)];
          }
        }
        let fileCache = uni.getStorageSync('mask_mp3');
        const prefix = this.isLowPhone ? 'gif' : 'png';
        console.log(fileCache);
        console.log(JSON.stringify(this.innerAudioContext));
        this.imageUrl =  this.isLiandui ? flash_map[type][this.audioType] : `${baseUrl}/noliandui/${this.audioType}.${prefix}` ;
        if(fileCache[flash_map['VoiceMap'][this.audioType]]) {
          this.innerAudioContext.src = fileCache[flash_map['VoiceMap'][this.audioType]];
        } else {
          this.innerAudioContext.src = flash_map['VoiceMap'][this.audioType];
        }
        this.innerAudioContext.onCanplay(()=>{
          this.innerAudioContext.play();
          this.innerAudioContext.offCanplay();
          this.innerAudioContext.onError((err) => {
            console.error(err);
          })
          this.innerAudioContext.onEnded(() => {
            clearTimeout(this.timer);
            console.log('mask_audio------------Ended');
            this.audioEnd = true;
            if (this.animationEnd && !this.emited) {
              this.emited = true;
              this.audioType = '';
              this.innerAudioContext.destroy();
              this.$emit("maskAnimationend");
            }
          })
        })
      }
    },
    IS_HIDE_MINI_APP(val) {
      if(val && this.maskType) {
        this.$emit("maskAnimationend", maskType);
      }
    }
  },
  computed: {
    ...mapState("yayaCommon", ["gold_count", "AWARD_EXT","IS_HIDE_MINI_APP"]),
  },
  created() {
    this.isLowPhone = uni.getStorageSync('IS_BLACKLIST') || '';
    if(this.isLowPhone) {
      this.timer1 = setTimeout(()=>{
        this.animationEnd = true;
        if (this.audioEnd && !this.emited) {
          clearTimeout(this.timer1);
          this.emited = true;
          this.audioType = '';
          this.innerAudioContext.destroy();
          this.$emit("maskAnimationend");
        }
      },3000);
    }
  },
  methods: {
    animationstart(maskType) {
      console.log('maskType')
    },
    animationend(maskType) {
      console.log('mask_animatio------------Ended');
      this.animationEnd = true;
      this.timer = setTimeout(()=>{
        if(!this.audioEnd) {
          this.emited = true;
          this.audioType = '';
          this.innerAudioContext.destroy();
          this.$emit("maskAnimationend", maskType);
        }
      },1100);
      if (this.audioEnd && !this.emited) {
        clearTimeout(this.timer);
        this.emited = true;
        this.audioType = '';
        this.innerAudioContext.destroy();
        this.$emit("maskAnimationend", maskType);
      }
    }
  }
}
</script>
<style lang="scss" scoped>
@import "../../../static/css/yaya-mixin.scss";
  .mask {
    background: rgba(0, 0, 0, 0.5);
    width: 100vw;
    height: 100vh;
    position: fixed;
    left: 0;
    bottom: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    .liandui{
      width: tovmin(900);
      height: tovmin(720);
      animation: animation1 3s steps(1) 1;
      background-size: tovmin(1800) tovmin(17280);
    }
    .liandui_gif{
      width: tovmin(900);
      height: tovmin(720);
      background-size: cover;
    }
    .no_liandui{
      width: tovmin(750);
      height: tovmin(690);
      animation: KeepTrying 3s steps(1) 1;
      background-size: tovmin(1500) tovmin(15180);
    }
  }
  @keyframes animation1 {
    0% { background-position: 0px 0px; }
    2.17% { background-position: tovmin(-900) 0px; }
    4.35% { background-position: 0px tovmin(-720); }
    6.52% { background-position: tovmin(-900) tovmin(-720); }
    8.70% { background-position: 0px tovmin(-1440); }
    10.87% { background-position: tovmin(-900) tovmin( -1440); }
    13.04% { background-position: 0px tovmin( -2160); }
    15.22% { background-position: tovmin(-900) tovmin( -2160); }
    17.39% { background-position: 0px tovmin( -2880); }
    19.57% { background-position: tovmin(-900) tovmin( -2880); }
    21.74% { background-position: 0px tovmin( -3600); }
    23.91% { background-position: tovmin(-900) tovmin( -3600); }
    26.09% { background-position: 0px tovmin( -4320); }
    28.26% { background-position: tovmin(-900) tovmin( -4320); }
    30.43% { background-position: 0px tovmin( -5040); }
    32.61% { background-position: tovmin(-900) tovmin( -5040); }
    34.78% { background-position: 0px tovmin( -5760); }
    36.96% { background-position: tovmin(-900) tovmin( -5760); }
    39.13% { background-position: 0px tovmin( -6480); }
    41.30% { background-position: tovmin(-900) tovmin( -6480); }
    43.48% { background-position: 0px tovmin( -7200); }
    45.65% { background-position: tovmin(-900) tovmin( -7200); }
    47.83% { background-position: 0px tovmin( -7920); }
    50.00% { background-position: tovmin(-900) tovmin( -7920); }
    52.17% { background-position: 0px tovmin( -8640); }
    54.35% { background-position: tovmin(-900) tovmin( -8640); }
    56.52% { background-position: 0px tovmin( -9360); }
    58.70% { background-position: tovmin(-900) tovmin( -9360); }
    60.87% { background-position: 0px tovmin(-10080); }
    63.04% { background-position: tovmin(-900) tovmin(-10080); }
    65.22% { background-position: 0px tovmin(-10800); }
    67.39% { background-position: tovmin(-900) tovmin(-10800); }
    69.57% { background-position: 0px tovmin(-11520); }
    71.74% { background-position: tovmin(-900) tovmin(-11520); }
    73.91% { background-position: 0px tovmin(-12240); }
    76.09% { background-position: tovmin(-900) tovmin(-12240); }
    78.26% { background-position: 0px tovmin(-12960); }
    80.43% { background-position: tovmin(-900) tovmin(-12960); }
    82.61% { background-position: 0px tovmin(-13680); }
    84.78% { background-position: tovmin(-900) tovmin(-13680); }
    86.96% { background-position: 0px tovmin(-14400); }
    89.13% { background-position: tovmin(-900) tovmin(-14400); }
    91.30% { background-position: 0px tovmin(-15120); }
    93.48% { background-position: tovmin(-900) tovmin(-15120); }
    95.65% { background-position: 0px tovmin(-15840); }
    97.83% { background-position: tovmin(-900) tovmin(-15840); }
    100.00% { background-position: 0px tovmin(-16560); }
  }
  // @keyframes animation1 {
  //   0% { background-position: 0px 0px;};
  //   2.94% { background-position: tovmin(900) 0px; }
  //   5.88% { background-position: 0px tovmin(-720) };
  //   8.82% { background-position: tovmin(900) tovmin(-720) };
  //   11.76% { background-position: 0px tovmin(-1440) };
  //   14.71% { background-position: tovmin(900) tovmin(-1440) };
  //   17.65% { background-position: 0px tovmin(-2160) };
  //   20.59% { background-position: tovmin(900) tovmin(-2160) };
  //   23.53% { background-position: 0px tovmin(-2880) };
  //   26.47% { background-position: tovmin(900) tovmin(-2880) };
  //   29.41% { background-position: 0px tovmin(-3600) };
  //   32.35% { background-position: tovmin(900) tovmin(-3600) };
  //   35.29% { background-position: 0px tovmin(-4320) };
  //   38.24% { background-position: tovmin(900) tovmin(-4320) };
  //   41.18% { background-position: 0px tovmin(-5040) };
  //   44.12% { background-position: tovmin(900) tovmin(-5040) };
  //   47.06% { background-position: 0px tovmin(-5760) };
  //   50.00% { background-position: tovmin(900) tovmin(-5760) };
  //   52.94% { background-position: 0px tovmin(-6480) };
  //   55.88% { background-position: tovmin(900) tovmin(-6480) };
  //   58.82% { background-position: 0px tovmin(-7200) };
  //   61.76% { background-position: tovmin(900) tovmin(-7200) };
  //   64.71% { background-position: 0px tovmin(-7920) };
  //   67.65% { background-position: tovmin(900) tovmin(-7920) };
  //   70.59% { background-position: 0px tovmin(-8640) };
  //   73.53% { background-position: tovmin(900) tovmin(-8640) };
  //   76.47% { background-position: 0px tovmin(-9360) };
  //   79.41% { background-position: tovmin(900) tovmin(-9360) };
  //   82.35% { background-position: 0px tovmin(-10080) };
  //   85.29% { background-position: tovmin(900) tovmin(-10080) };
  //   88.24% { background-position: 0px tovmin(-10800) };
  //   91.18% { background-position: tovmin(900) tovmin(-10800) };
  //   94.12% { background-position: 0px tovmin(-11520) };
  //   97.06% { background-position: tovmin(900) tovmin(-11520) };
  //   100.00% { background-position: 0px tovmin(-12240) };
  // }
  @keyframes KeepTrying {
    0% { background-position: 0px 0px; }
    2.33% { background-position: tovmin(-750) 0px; }
    4.65% { background-position: 0px tovmin(-690); }
    6.98% { background-position: tovmin(-750) tovmin(-690); }
    9.30% { background-position: 0px tovmin(-1380); }
    11.63% { background-position: tovmin(-750) tovmin(-1380); }
    13.95% { background-position: 0px tovmin(-2070); }
    16.28% { background-position: tovmin(-750) tovmin(-2070); }
    18.60% { background-position: 0px tovmin(-2760); }
    20.93% { background-position: tovmin(-750) tovmin(-2760); }
    23.26% { background-position: 0px tovmin(-3450); }
    25.58% { background-position: tovmin(-750) tovmin(-3450); }
    27.91% { background-position: 0px tovmin(-4140); }
    30.23% { background-position: tovmin(-750) tovmin(-4140); }
    32.56% { background-position: 0px tovmin(-4830); }
    34.88% { background-position: tovmin(-750) tovmin(-4830); }
    37.21% { background-position: 0px tovmin(-5520); }
    39.53% { background-position: tovmin(-750) tovmin(-5520); }
    41.86% { background-position: 0px tovmin(-6210); }
    44.19% { background-position: tovmin(-750) tovmin(-6210); }
    46.51% { background-position: 0px tovmin(-6900); }
    48.84% { background-position: tovmin(-750) tovmin(-6900); }
    51.16% { background-position: 0px tovmin(-7590); }
    53.49% { background-position: tovmin(-750) tovmin(-7590); }
    55.81% { background-position: 0px tovmin(-8280); }
    58.14% { background-position: tovmin(-750) tovmin(-8280); }
    60.47% { background-position: 0px tovmin(-8970); }
    62.79% { background-position: tovmin(-750) tovmin(-8970); }
    65.12% { background-position: 0px tovmin(-9660); }
    67.44% { background-position: tovmin(-750) tovmin(-9660); }
    69.77% { background-position: 0px  tovmin(-10350); }
    72.09% { background-position: tovmin(-750)  tovmin(-10350); }
    74.42% { background-position: 0px  tovmin(-11040); }
    76.74% { background-position: tovmin(-750)  tovmin(-11040); }
    79.07% { background-position: 0px  tovmin(-11730); }
    81.40% { background-position: tovmin(-750)  tovmin(-11730); }
    83.72% { background-position: 0px  tovmin(-12420); }
    86.05% { background-position: tovmin(-750)  tovmin(-12420); }
    88.37% { background-position: 0px  tovmin(-13110); }
    90.70% { background-position: tovmin(-750)  tovmin(-13110); }
    93.02% { background-position: 0px  tovmin(-13800); }
    95.35% { background-position: tovmin(-750)  tovmin(-13800); }
    97.67% { background-position: 0px  tovmin(-14490); }
    100.00% { background-position: tovmin(-750)  tovmin(-14490); }
  }
</style>