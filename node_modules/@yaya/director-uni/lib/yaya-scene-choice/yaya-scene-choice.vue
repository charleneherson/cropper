<template>
  <view class="scene_choice">
    <!-- 场景内的布局组织自定义： -->
    <!-- <view>{{scene && scene.raw && scene.raw.title}}</view> -->
    <view class="bg_left"></view>
    <view class="bg_right"></view>
    <view v-if="showLayer" class="sence-change"></view>

    <swiper
      v-if="scene"
      class="swiper"
      :autoplay="false"
      :current="currentQuestion"
      @change="changeSwiper"
      @animationfinish="animationfinish"
      disable-touch
    >
      <swiper-item
        class="swiper-item"
        v-for="(question, idx) in scene.data.ext.questionList"
        :key="question.tid"
        catchtouchmove="stopTouchMove"
      >
        <yayaChoiceCard
          :question="question"
          :pageIndex="idx"
          :currentPage="currentQuestion"
          :allStop="allStop"
          :isPause="pauseAudioAndRecord"
          @nextQuestion="nextQuestion"
          @answerRecord="answerRecord"
        />
      </swiper-item>
    </swiper>
    <!-- 序号  -->
    <SerialNumber
      v-if="scene && scene.data.ext.questionList"
      class="reading_serial_number"
      :serialData="{
        current: currentQuestion + 1,
        total: scene.data.ext.questionList.length,
      }"
    />
    <mask
      v-if="maskType"
      @maskAnimationend="remarkEnded"
      :maskType="maskType"
    />
  </view>
</template>
<script>
import yayaScene from "../yaya-scene/yaya-scene.vue";
import mask from "../yaya-common/components/mask/mask";
import yayaChoiceCard from "./components/yaya-choice-card.vue";
import SerialNumber from "../yaya-common/components/serial-number/index.vue";
import { mapState, mapMutations } from "vuex";
export default {
  name: "yayaSceneChoice",
  // 扩展场景基类（vue的extends好菜，vue+uniapp+mp）
  extends: yayaScene,
  components: {
    yayaChoiceCard,
    mask,
    SerialNumber,
  },
  props: {},
  data() {
    return {
      currentQuestion: 0,
      correctCount: 0,
      showMask: false,
      allStop: false,
      pauseAudioAndRecord: true,
      maskType: "",
      showLayer: false,
    };
  },
  created() {},
  mounted() {
    this.scene.onPause((payload) => {
      if (payload.isIntercepted) {
        // 暂停你的场景，停止音频、视频的播放，停止录音
        this.allStop = true;
        this.pauseAudioAndRecord = true;
      }
    });
    this.scene.onResume((payload) => {
      // 恢复你的场景
      this.allStop = false;
      this.pauseAudioAndRecord = false;
    });
    this.scene.onStart((payload) => {
      this.start();
      this.allStop = false;
      this.pauseAudioAndRecord = false;
    });
  },
  methods: {
    stopTouchMove() {
      return false;
    },
    changeSwiper(res) {
      this.currentQuestion = res.detail.current;
    },
    nextQuestion(data, maskType) {
      this.showMask = true;
      console.log(maskType)
      this.maskType = maskType;
      this.interact("anwsered", data);
    },
    // 回答记录
    answerRecord(data) {
      this.interact("anwserRecord", data);
    },
    remarkEnded() {
      console.log('答完结束了答完结束了答完结束了答完结束了答完结束了')
      this.maskType = "";
      this.currentQuestion++;
      this.correctCount++;
      this.showLayer = true;
      let scene = this.scene;
      if (this.correctCount === scene.data.ext.questionList.length) {
        this.$emit("act", scene.actions.success);
        return;
      }
    },
    animationfinish() {
      this.$nextTick(() => {
        setTimeout(() => {
          this.showLayer = false;
        }, 500);
      });
    },
  },
};
</script>
<style lang="scss" scoped>
@import "../static/css/yaya-mixin.scss";
.scene_choice {
  width: 100vw;
  height: 100vh;
  background-color: #89cce5;
  position: relative;
  .bg_left {
    height: 100vh;
    width: tovmin(521);
    position: absolute;
    left: 0;
    bottom: 0;
    background: url("https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/icons/bg_left_4_reading.png")
      0 0 no-repeat;
    background-size: cover;
  }
  .bg_right {
    height: tovmin(335);
    width: tovmin(533);
    position: absolute;
    right: 0;
    bottom: 0;
    background: url("https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/icons/bg_right_4_reading.png")
      0 0 no-repeat;
    background-size: cover;
  }
  .sence-change {
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0);
    position: fixed;
    left: 0;
    top: 0;
    z-index: 100;
  }
}
.swiper {
  width: 100vw;
  height: 100vh;
}
</style>
