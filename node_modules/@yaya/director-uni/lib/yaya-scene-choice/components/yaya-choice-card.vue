<template>
  <view class="choice-box">
    <view class="choice-container" :class="[{'isPad':IS_IPAD}]">
      <view class="question_head" :class="[
          {'question_head_only_audio': !question.question.stems.image && !question.question.stems.title},
          {'question_head_audio_text': !question.question.stems.image && question.question.stems.title && question.question.stems.audio}
        ]">
          <image 
            v-if="question.question.stems.image"
            :src="question.question.stems.image.url" />
          <view 
            v-if="question.question.stems.title && question.question.stems.image"
            class="text_btn">{{ question.question.stems.image ? question.question.stems.title.slice(0,20) : question.question.stems.title.slice(0,20) }}</view>
        <view 
          class="question_text"
          v-if="question.question.stems.title && !question.question.stems.image"
          >
            <view class="text_title">{{ question.question.stems.title }}</view>
          </view>
        <view 
          v-if="question.question.stems.audio"
          class="audio_icon"
          :class="[{'audio_play':!isPlay}, {'only_audio':!question.question.stems.image && !question.question.stems.title, 'only_audio_4': !question.question.stems.image && !question.question.stems.title && optionsLength === 4}]"
          @click="playAudio(question.question.stems.audio)"
        ></view>
      </view>
      <view class="question_bottom" :class="[{'options_box_four_audio':optionsLength === 4 && question.question.options.A.optionTitle && !question.question.stems.image && !question.question.stems.title && question.question.stems.audio}]">
        <!-- 2个选项 -->
        <view 
          :class="['options_box',{'short_two_box':(optionsType === 'shortImage' || optionsType === 'shortText') && optionsLength === 2},
            {'options_box_four_audio':optionsLength === 4 && question.question.options.A.optionTitle && !question.question.stems.image && !question.question.stems.title && question.question.stems.audio}]">
          <view 
            v-for="(val, key) in question.question.options" 
            :key="key"
          >
            <option-list 
              :option="val"
              :optionsLength="optionsLength"
              :optionsType="optionsType"
              :choose="question.question.choose"
              :optionName="key"
              :isShowTips="isShowTips"
              :allRightIcon="allRightIcon"
              :question="question.question"
              @rightChoose="rightChoose"
            />
          </view>
        </view>
      </view>
    </view>
  </view>
</template>
<script>
const errorSelectAudio0 = require('../../static/audio/not_this.mp3');
const errorSelectAudio1 = require('../../static/audio/think_again.mp3');
const errorSelectAudio2 = require('../../static/audio/think_about.mp3');
const errorSelectAudio3 = 'https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-common/audio/choice-wrong-tip01.mp3';
const errorSelectAudio4 = 'https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-common/audio/choice-wrong-tip02.mp3';
const errorSelectAudio5 = 'https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-common/audio/choice-wrong-tip03.mp3';
const errorSelectAudio6 = 'https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-common/audio/choice-wrong-tip04.mp3';
const errorSelectAudio7 = 'https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-common/audio/choice-wrong-tip05.mp3';
const isTips1 = 'https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-common/audio/tips_kuailaixuanyixuan.mp3',
      isTips2 = 'https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-common/audio/choice-timeout-tip01.mp3',
      isTips3 = 'https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-common/audio/choice-timeout-tip03.mp3';
const duoxuan_right = "https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-write/right_sound.mp3";
const has_more1 = 'https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-choice/audio/hasmore_more.mp3';
const has_more2 = 'https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-choice/audio/hasmore_orther.mp3';
import optionList from './option-list';
import { mapState } from "vuex";
export default {
  name: "yayaChoiceCard",
  components: {
    optionList,
  },
  props: {
    question: {
      type: Object,
      default: () => {}
    },
    pageIndex: {
      type: [Number,String],
      default: 0
    },
    currentPage: {
      type: [Number,String],
      default: 0
    },
    allStop: {
      type: Boolean,
      default: false
    },
    isPause: {
      type: Boolean,
      default: true
    }
  },
  data() {
    return {
      innerAudioContext: null,
      optionsType: null, 
      optionsLength: null, 
      isPlay: true,
      timer: null,
      allRightIcon: false, // 全对标志
      isFirstRight: true, // 第一次答对标识
      isShowTips: false, // 展示提示
      // oneMinuTimer: null, //一分钟未选状态
      hasChoose: '', // 已选选项 
      startTime: 0,
      errorAudioArr: [errorSelectAudio0,errorSelectAudio1,errorSelectAudio2,errorSelectAudio3,errorSelectAudio4,errorSelectAudio5,errorSelectAudio6,errorSelectAudio7],
      isRightAudioArr: duoxuan_right,
      isTipsAudioArr: [isTips1,isTips2,isTips3],
      isTipsMoreAudioArr: [has_more1,has_more2],
      isAllNotClick: false, 
      chooseFlag: 0,
      chooseKey: '0',
    }
  },
  watch: {
    currentPage(val) {
      // clearTimeout(this.oneMinuTimer);
      clearTimeout(this.timer);
      if(val === this.pageIndex && !this.isPause) {
        this.initAudio()
      }
    },
    allStop(val) {
      this.tipsAudioContext && this.tipsAudioContext.stop();
      this.titkeAudioContext && this.titkeAudioContext.stop();
      this.innerAudioContext && this.innerAudioContext.stop();
      // this.oneMinuTimer && clearTimeout(this.oneMinuTimer);
      this.timer && clearTimeout(this.timer);
    },
    isPause(val) {
      if (!val) {
        clearTimeout(this.timer);
        if(this.currentPage === this.pageIndex) {
          this.initAudio()
        }
      }
    }
  },
  computed: {
    ...mapState("yayaCommon", ["IS_IPAD"]),
  },
  created() {
    this.getOptionsType();
    if(this.pageIndex === 0 && !this.isPause) {
      this.initAudio();
    }
  },
  methods: {
    initAudio() {
      this.titkeAudioContext = wx.createInnerAudioContext();
      this.innerAudioContext = wx.createInnerAudioContext();
      this.tipsAudioContext = wx.createInnerAudioContext();
      this.startTime = +new Date();
      if(this.question.question.stems.audio) {
        this.playAudio(this.question.question.stems.audio.url);
      } else {
        this.showTips();
      }
    },
    getOptionsType() {
      let objArr = Object.values(this.question.question.options);      
      let text;
      this.optionsLength = objArr.length;
      for(var i = 0, l = objArr.length; i < l; i++) {
        if(l == 2) {
          if(objArr[i].optionImage) {
            text = "shortImage";
          } else if(objArr[i].optionTitle.length > 3) {
            text = "longText";
            break;
          } else {
            text = "shortText";
          }
        } else if(l == 4){
          if(objArr[i].optionImage) {
              text = "shortImage";
            } else if(objArr[i].optionTitle.length > 3) {
              text = "longText";
              break
            } else {
              text = "shortText";
            }
        } else {
          if(objArr[i].optionImage) {
            text = "shortImage";
          } else if(objArr[i].optionTitle.length > 2) {
            text = "longText";
            break
          } else {
            text = "shortText";
          }
        }
      }
      this.optionsType = text;
    },
    // 播放题目音频
    playAudio(audio) {
      if(this.isAllNotClick) {return}
      if (this.isPlay) {
        this.innerAudioContext.stop();
        this.tipsAudioContext.stop();
        this.titkeAudioContext.src = audio;
        this.titkeAudioContext.play();
        this.titkeAudioContext.onEnded(() => {
          this.isPlay = true;
          this.showTips();
        });
      } else {
        this.titkeAudioContext.stop(()=>{
          this.isPlay = true;
          this.showTips();
        });
      }
      this.isPlay = !this.isPlay;
    },
    // 展示提示
    showTips() {
      clearTimeout(this.timer);
      let tipsArc, delayTime;
      // 多选
      if(this.hasChoose) {
        tipsArc = this.isTipsMoreAudioArr[this.random(this.isTipsMoreAudioArr.length)];
        delayTime = 10000;
        } else {
        tipsArc = this.isTipsAudioArr[this.random(this.isTipsAudioArr.length)];
        delayTime = 20000;
      }
      this.tipsAudioContext.src = tipsArc;
      this.timer = setTimeout(() => {
        this.tipsAudioContext.play();
        this.isShowTips = true;
        clearTimeout(this.timer);
        //一分钟计时
        // this.oneMinuTimerStay();
      }, delayTime)
    },
    // 答对
    rightChoose(data) {
      this.isPlay = true;
      const {chooseFlag,chooseKey} = data;
      this.chooseFlag = chooseFlag;
      this.chooseKey = chooseKey;
      const _this = this;
      clearTimeout(this.timer);
      clearTimeout(this.oneMinuTimer);
      this.isShowTips = false;
      this.innerAudioContext && this.innerAudioContext.stop();
      this.titkeAudioContext && this.titkeAudioContext.stop();
      this.tipsAudioContext && this.tipsAudioContext.stop();
      let idx;
      // 选错
      if(!this.chooseFlag) {
        this.chooseOptionAudioPlay(this.errorAudioArr[this.random(this.errorAudioArr.length)]);
        this.isFirstRight = false;
        this.showTips();
      } else {
        // 选对的选项
        this.hasChoose += chooseKey;
        this.chooseOptionAudioPlay(this.isRightAudioArr);
        // 全对
        if(this.hasChoose.length === this.question.question.choose.length) {
          this.allRightIcon = true;
          this.isAllNotClick = true;
          setTimeout(()=>{
            this.goNext();
          },600)
        }
      }
    },
    oneMinuTimerStay() {
      clearTimeout(this.oneMinuTimer);
      // 一分钟未选择
      this.oneMinuTimer = setTimeout(() => {
        this.allRightIcon = true;
        this.isFirstRight = false;
          // 全对，播完音效进下一题
          this.goNext();
          clearTimeout(this.oneMinuTimer);
      }, 60000)
    },
    random(maxNum) {
      return Math.floor(Math.random()*maxNum);
    },
    chooseOptionAudioPlay(src) {
      this.innerAudioContext.src = src;
      this.innerAudioContext.play();
      this.innerAudioContext.onEnded(()=> {
        this.showTips();
      })
    },
    goNext() {
      const submitObj = {
        type: this.question.category,
        userKv: ''
      }
      const maskType = this.isFirstRight ? ['first', 'notReading'] : ['notFirst', 'notReading'];
      // 提交数据
      submitObj.answerData = this.formatAnswerData(true,this.question.question.choose);
      submitObj.first = this.isFirstRight ? 1 : 0;
      console.log(submitObj);
      this.$emit('nextQuestion',submitObj,maskType);

      this.answerRecord(this.chooseFlag,this.chooseKey);
    },
    // 作答记录
    answerRecord(chooseFlag,chooseKey) {
      const submitObj = {
        type: this.question.category
      }
      const answerInfo ={
        tidId: this.question.tid,
        tidType: this.question.category,
        isCorrect: chooseFlag?1:0
      }
      // 提交数据
      answerInfo.answerData = this.formatAnswerData(chooseFlag,chooseKey);
      submitObj.answerData = answerInfo
      console.log(submitObj);
      this.$emit('answerRecord',submitObj);
    },
    formatAnswerData(chooseFlag,chooseKey) {
      const answerData = {}, tidData = {isSign:1,correct:chooseFlag?1:0};
      tidData.answer = chooseKey.split('');
      tidData.duration = parseInt((+new Date() - this.startTime)/1000); 
      tidData.userKv = [this.optionsType];
      answerData[this.question.tid] = tidData;
      return answerData;
    }
  },
  destroyed() {
    this.innerAudioContext && this.innerAudioContext.stop();
    this.tipsAudioContext && this.tipsAudioContext.stop();
    this.titkeAudioContext && this.titkeAudioContext.stop();
    // clearTimeout(this.oneMinuTimer);
    clearTimeout(this.timer);
  },
};
</script>
<style  lang="scss" scoped>
  @import "../../static/css/yaya-mixin.scss";
  .choice-box{
    width: 100vw;
    height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding-top:tovmin(64);
    box-sizing: border-box;
    .choice-container{
      width: tovmin(916);
      box-sizing: border-box;
      height: auto;
      display: flex;
      flex-direction: column;
      margin: auto 0;
      &.isPad{
        transform: scale(0.7,0.8);
      }
      .question_head{
        width: tovmin(916);
        height: auto;
        box-sizing: border-box;
        background: #ffffff;
        border-radius: tovmin(36);
        position: relative;
        font-size: 0;
        image{
          border-radius: tovmin(36);
          @include w_h(900,300);
          border: tovmin(8) solid rgba(255,255,255,1);
        }
        .text_btn{
          @include btn_common(480,60,32,#FFFFFF,rgba(0,0,0,.6));
          width: auto;
          min-width:tovmin(100);
          padding: 0 tovmin(32);
          position: absolute;
          left: 50%;
          bottom: tovmin(24);
          transform: translate3d(-50%,0,0);
          overflow: hidden;
          font-weight: 700;
          font-family: PingFangSC-Medium,PingFang SC;
          white-space: nowrap;
        }
        .question_text{
          @include btn_common(916,176,36,#333333,#F1F1F1,36);
          border: tovmin(8) solid rgba(255,255,255,1);
          // font-weight: 300;
          font-family: PingFangSC-Medium,PingFang SC;
          box-sizing: border-box;
          font-weight: 700;
          display: flex;
          flex-direction: row;
          align-items: center;
          line-height: 1.5;
          justify-content: center;
          .text_title{
            padding: 0 tovmin(50);
            text-align: left;

          }
        }
        .audio_icon{
          @include circle_view(91);
          background: url('https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-choice/audio_flash.png') no-repeat;
          background-size: auto 100%;
          position: absolute;
          left: tovmin(-37);
          top: 50%;
          transform: translate3d(0,-50%,0);
          background-position-x:100%;
          &.audio_play {
            animation: horn-animation 1.2s steps(2, end) infinite;
          }
          &.only_audio {
            left: 49%;
            top: tovmin(-60);
            margin-left: tovmin(-50);
          }
          &.only_audio_4 {
            left: 51.3%;
            top: tovmin(-60);
            margin-left: tovmin(-50);
          }
        }
      }
      .question_head_only_audio {
        margin-top: tovmin(95);
      }
      .question_head_audio_text {
        border-radius: tovmin(36);
      }
      .question_bottom{
        width: tovmin(916);
        margin-top: tovmin(30);
        .options_box{
          display: flex;
          justify-content: space-between;
          width: tovmin(916);
          flex-wrap: wrap;
          &.short_two_box{
            justify-content: center;
          }
        }
        .options_box_four_audio {
          width: tovmin(1100);
        }
      }
      .options_box_four_audio {
        width: tovmin(1100);
        margin-left: tovmin(-41);
      }
    }
  }
@keyframes horn-animation {
  0% {
    background-position-x: 0;
  }
  50% {
    background-position-x: 100%;
  }
  100% {
    background-position-x: 100%;
  }
}
</style>
