<template>
  <view class="scene_write">
    <view class="bg_left"></view>
    <view class="bg_right"></view>
    <!-- 场景内的布局组织自定义： -->
    <!-- <view>{{scene && scene.raw && scene.raw.title}}</view> -->
    <view class="total_write" v-if="scene.data.ext.questionList.length > 1">
      <view
        v-for="(question, idx) in scene.data.ext.questionList"
        :key="idx"
        :class="[
          'write_text',
          { hasLearn: idx <= currentQuestion },
          { isSelect: idx === currentQuestion },
        ]"
        >{{ question.title }}</view
      >
    </view>
    <view class="write_box">
      <view class="write_box_left" :class="{ isPad: IS_IPAD }">
        <view class="flash_box">
          <!-- <view :class="flashArr[flashStatus]"></view> -->
          <!-- 此处需将四种状态初次渲染处理，避免首次背景图改变导致有空白闪烁情况 -->
          <view v-show="flashStatus === 0" :class="flashArr[0]"></view>
          <view v-show="flashStatus === 1" :class="flashArr[1]"></view>
          <view v-show="flashStatus === 2" :class="flashArr[2]"></view>
          <view v-show="flashStatus === 3" :class="flashArr[3]"></view>
        </view>
        <view class="left"> </view>
      </view>
      <view class="write_box_right" :class="{ is_Pad: IS_IPAD }">
        <swiper
          class="swiper"
          :vertical="true"
          :duration="800"
          :autoplay="false"
          :current="currentQuestion"
          @change="changeSwiper"
        >
          <swiper-item
            class="swiper-item"
            v-for="(question, idx) in scene.data.ext.questionList"
            :key="question.tid"
            catchtouchmove="stopTouchMove"
          >
            <yayaWriteCard
              :question="question"
              :pageIndex="idx"
              :currentPage="currentQuestion"
              :allStop="allStop"
              :isPause="pauseAudioAndRecord"
              @doRight="doRight"
              @nextQuestion="nextQuestion"
              @answerRecord="answerRecord"
              @changeFlashStatus="changeFlashStatus"
            />
          </swiper-item>
        </swiper>
      </view>
    </view>

    <SerialNumber
      v-if="scene && scene.data.ext.questionList.length > 1"
      class="reading_serial_number"
      :serialData="{
        current: currentQuestion + 1,
        total: scene && scene.data.ext.questionList.length,
      }"
    />
    <mask
      v-if="maskType"
      @maskAnimationend="remarkEnded"
      :maskType="maskType"
    />
    <yayaWriteWordCard
      v-if="showWordCard"
      @gatherFinish="gatherFinish"
      :write="scene.data.ext.questionList[currentQuestion].title"
    />
  </view>
</template>
<script>
import mask from "../yaya-common/components/mask/mask";
import SerialNumber from "../yaya-common/components/serial-number/index.vue";
import yayaScene from "../yaya-scene/yaya-scene.vue";
import yayaWriteCard from "./components/yaya-write-card.vue";
import yayaWriteWordCard from "./components/yaya-write-word-card.vue";
import { mapState } from "vuex";
export default {
  name: "yayaSceneWrite",
  // 扩展场景基类（vue的extends好菜，vue+uniapp+mp）
  extends: yayaScene,
  components: {
    yayaWriteCard,
    SerialNumber,
    mask,
    yayaWriteWordCard,
  },
  props: {},
  computed: {
    ...mapState("yayaCommon", ["IS_IPAD", "coreStudied", "wordswitch"]),
  },
  data() {
    return {
      currentQuestion: 0,
      correctCount: 0,
      allStop: false,
      pauseAudioAndRecord: true,
      maskType: "",
      //动画间隔
      flashArr: ["yaya-wait", "yaya-expect", "yaya-dismay", "yaya-finish"],
      flashStatus: 0,
      flashTimer: null,
      showWordCard: false,
    };
  },
  mounted() {
    this.scene.onPause((payload) => {
      if (payload.isIntercepted) {
        // 暂停你的场景，停止音频、视频的播放，停止录音
        this.allStop = true;
        this.pauseAudioAndRecord = true;
      }
    });
    this.scene.onResume((payload) => {
      // 恢复你的场景
      this.allStop = false;
      this.pauseAudioAndRecord = false;
    });
    this.scene.onStart((payload) => {
      this.start();
      this.allStop = false;
      this.pauseAudioAndRecord = false;
    });
  },
  methods: {
    changeSwiper(res) {
      this.currentQuestion = res.detail.current;
    },
    stopTouchMove() {
      return false;
    },
    nextQuestion(data, isWonderful) {
      this.maskType = isWonderful
        ? ["first", "notReading"]
        : ["notFirst", "notReading"];
      this.interact("anwsered", data);
    },
    // 回答记录
    answerRecord(data) {
      this.interact("anwserRecord", data);
    },
    remarkEnded() {
      let scene = this.scene;
      //判断核心字是否已经收集
      console.log(
        scene.data.ext.questionList,
        this.currentQuestion,
        scene.data.ext.questionList[this.currentQuestion - 1]
      );
      let wordswitch = Boolean(this.wordswitch); //开关暂时写死
      // let wordswitch = true; //开关暂时写死
      let nowWord = scene.data.ext.questionList[this.currentQuestion].title;
      if (
        wordswitch &&
        this.coreStudied &&
        !this.coreStudied.includes(nowWord)
      ) {
        this.maskType = "";
        this.showWordCard = true;
      } else {
        this.changeWord();
      }
    },
    // 切换字体与切换场景逻辑
    changeWord() {
      let scene = this.scene;
      this.maskType = "";
      this.currentQuestion++;
      this.correctCount++;
      if (this.correctCount === scene.data.ext.questionList.length) {
        console.log(this.scene.data.ext.questionList, this.currentQuestion);
        this.$emit("act", scene.actions.success);
      }
    },
    //记录背景动画变化
    changeFlashStatus(status) {
      if (this.flashTimer && status !== 3) return;
      this.flashStatus = status;
      if (status !== 3) {
        setTimeout(() => {
          if (this.flashStatus !== 3) {
            //避免最后吃鱼状态被期待状态影响
            this.flashStatus = 0;
          }
        }, 2200);
      } else {
        setTimeout(() => {
          this.flashStatus = 0;
        }, 3000);
      }
      this.flashTimer = setTimeout(() => {
        this.flashTimer = false;
      }, 200);
    },
    //核心字收集完成
    gatherFinish(write) {
      this.showWordCard = false;
      if (!write) return;
      console.log(write);
      //提交数据切换场景
      let params = {
        data: {
          type: 1,
          word: write,
        },
        type: "wordcardgather",
      };
      this.interact("scenePost", params);
      this.changeWord();
    },
  },
};
</script>
<style lang="scss" scoped>
@import "../static/css/yaya-mixin.scss";
.scene_write {
  width: 100vw;
  height: 100vh;
  position: relative;
  background-color: #89cce5;
  .bg_left {
    @include w_h(244, 123);
    position: absolute;
    left: 0;
    bottom: tovmin(196);
    background: url("https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-write/bg_right.png")
      0 0 no-repeat;
    background-size: cover;
  }
  .bg_right {
    @include w_h(421, 155);
    position: absolute;
    right: 0;
    bottom: tovmin(162);
    background: url("https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-write/bg_left.png")
      0 0 no-repeat;
    background-size: cover;
  }
  .total_write {
    position: absolute;
    @include btn_common(0, 66, 28, #ffffff, rgba(0, 0, 0, 0.3));
    width: auto;
    max-height: 66;
    display: flex;
    left: tovmin(121);
    top: tovmin(131);
    padding: 0 tovmin(30);
    align-items: center;
    z-index: 10;

    .write_text {
      line-height: 1;
      font-size: tovin(30);
      margin-right: tovmin(20);
      opacity: 0.5;
      &.isSelect {
        @include btn_common(84, 84, 40, #ffffff, #ff6a6a, 24);
        margin-right: tovmin(20);
        opacity: 1;
      }
      &.hasLearn {
        opacity: 1;
      }
      &:last-of-type {
        margin-right: 0;
      }
    }
  }
  .swiper {
    // width: 100vw;
    // width: calc(50vw + 215px);
    height: 100vh;
  }
  //@
  .write_box {
    display: flex;
    justify-content: center;
    .isPad {
      margin-top: 200px;
    }
    .is_Pad {
      padding-top: 200px;
    }
    .write_box_left {
      position: relative;
      min-width: 200px;
      margin-right: 10vw;
    }
    .write_box_right {
      width: tovmin(560);
    }
    @media only screen and (min-device-width: 560px) and (max-device-width: 1136px) and (-webkit-min-device-pixel-ratio: 2) {
      /* iPhone 5 only */
      .write_box_right {
        width: tovmin(660) !important;
      }
    }
  }
  .flash_box {
    width: 400px;
    height: 275px;
    overflow: hidden;
    position: absolute;
    top: tovmin(96);
    .yaya-wait {
      width: 200px;
      background: url("https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-write/yaya_daiji.png");
      height: 275px;
      background-size: cover;
      animation: yy-wait-animation 2s steps(16) infinite;
    }
    .yaya-expect {
      width: 200px;
      background: url("https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-write/yaya_qidai_new.png");
      height: 275px;
      background-size: cover;
      animation: yy-expect-animation 2.5s steps(19) 1;
    }
    .yaya-dismay {
      width: 200px;
      background: url("https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-write/yaya_jusang.png");
      height: 275px;
      background-size: cover;
      animation: yy-dismay-animation 2s steps(19) 1;
    }
    .yaya-finish {
      width: 400px;
      background: url("https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-write/yayachiyu_new.png");
      height: 275px;
      background-size: cover;
      animation: yy-finish-animation 3s steps(25) 1;
    }
  }
  .left {
    // @include v_w_h_center(486, 339);
    // width: 188px;
    height: 235px;
    margin-right: tovmin(148);
    overflow: hidden;
  }
  @keyframes yy-wait-animation {
    0% {
      background-position-x: 0;
    }
    100% {
      background-position-x: -1600%;
    }
  }
  @keyframes yy-expect-animation {
    0% {
      background-position-x: 0;
    }
    100% {
      background-position-x: -1900%;
    }
  }
  @keyframes yy-dismay-animation {
    0% {
      background-position-x: 0;
    }
    100% {
      background-position-x: -1900%;
    }
  }
  @keyframes yy-finish-animation {
    0% {
      background-position-x: 0;
    }
    100% {
      background-position-x: -2500%;
    }
  }
}
</style>
