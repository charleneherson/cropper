<template>
  <view class="write-box">
    <view class="write-container">
      <view class="right">
        <view class="canvas-wrapper">
          <view v-show="showCanvas">
            <HanziWriterComp
              :show="showCanvas"
              ref="hanziWriter"
              :width="270"
              :height="270"
              backgroundImage="url('https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-write/bg_write_new.png')"
            />
          </view>

          <view v-show="!showCanvas" class="mock-img">
            <img style="width:270px;height:270px" :src="canvasImg" />
          </view>

          <view class="anime-mask" v-if="animeShow">
            <view :animation="penAnimeData" class="animate-draw">
              <image
                class="animate-draw-pen"
                src="https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-write/pen_icon.png"
              />
              <!-- <view class="animate-draw-lizi"> </view> -->
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
</template>
<script>
import HanziWriterComp from "./hanziWrite/HanziWriter.vue";
import HanziWriter from "./hanziWrite/index";

export default {
  name: "yayaWriteCard",
  components: {
    HanziWriterComp,
  },
  props: {
    question: {
      type: Object,
      default: () => {},
    },
    pageIndex: {
      type: Number,
      default: 0,
    },
    currentPage: {
      type: Number,
      default: 0,
    },
    allStop: {
      type: Boolean,
      default: false,
    },
    isPause: {
      type: Boolean,
      default: true,
    },
  },
  computed: {},
  data() {
    return {
      innerAudioContext: null,
      innerAudioContext1: null, //三秒提示音频
      timer: null,
      canSubmit: false,
      isShowGif: false,
      startTime: 0,
      isPlay: false,
      // 画笔动画数据
      penAnimeData: null,
      // 画笔动画配置
      animeOption: {
        duration: 300,
        timingFunction: "linear",
      },
      // 画笔笔触类型
      penStrokeArray: [
        {
          type: "bamboo",
          url:
            "https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-write/bamboo_icon.png",
          width: 100,
          height: 100,
        },
        {
          type: "fish",
          url:
            "https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-write/fish_icon.png",
          width: 100,
          height: 100,
        },
        {
          type: "yinghua",
          url:
            "https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-write/yinghua_icon.png",
          width: 100,
          height: 100,
        },
      ],
      //书写间隔提示音频
      intervalWarnArray: [
        {
          url:
            "https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-write/write_warning_tone1.mp3",
        },
        {
          url:
            "https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-write/write_warning_tone2.mp3",
        },
        {
          url:
            "https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-write/write_warning_tone3.mp3",
        },
        {
          url:
            "https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-write/write_warning_tone4.mp3",
        },
      ],
      curPenStroke: {
        type: "bamboo",
        url:
          "https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-write/bamboo_icon.png",
        imageData: "",
        width: 100,
        height: 100,
      },
      userStrokes: [],
      intervalWarnTimer: null,
      blockId: 0, //笔画区分的章节ID
      isWonderful: true,
      showCanvas: true,
      canvasImg: "",
      animeTimer: null,
      animeShow: true,
      isToStop: false, //此变量为了处理多次暂停init画板导致样式错乱
      perPoint: null, //记录补点
      perDrawPoint: null, //记录画笔绘制点
      allDuration: 0, //总持续时间，为了解决循环毛笔间隔时间
    };
  },
  watch: {
    currentPage(val) {
      if (val === this.pageIndex && !this.isPause) {
        this.initWriter(this.question);
      }
    },
    allStop(val) {
      if (val) {
        this.isToStop = true;
      }
    },
    isPause(val) {
      if (!val) {
        if (this.currentPage === this.pageIndex && !this.isToStop) {
          this.initWriter(this.question);
        }
      }
    },
  },
  created() {
    // 初始化画笔动画
    // var animation = uni.createAnimation(this.animeOption);
    // this.animation = animation;
    // console.log("初始化画笔动画");
  },
  mounted() {},
  methods: {
    async getCanvasDom(ref) {
      return new Promise((resolve) => {
        uni
          .createSelectorQuery()
          .in(ref)
          .select("#writer-canvas")
          .fields({ node: true, size: true })
          .exec((res) => {
            const canvas = res[0].node;
            const ctx = canvas.getContext("2d");
            resolve({
              ctx,
              canvasInstance: canvas,
            });
          });
      });
    },
    async initWriter(question) {
      let { title, audio } = question;
      console.log("初始化写字器");
      // 初始化画笔动画
      var animation = uni.createAnimation(this.animeOption);
      this.animation = animation;
      //播放进入时音效
      if (this.innerAudioContext) {
        this.innerAudioContext.destroy();
      }
      this.innerAudioContext = wx.createInnerAudioContext();
      this.innerAudioContext.src = audio.url;
      this.innerAudioContext.play();
      this.innerAudioContext.onEnded(() => {
        this.handleDelayFn();
      });
      //生成画笔
      this.blockId = (this.question && this.question.blockId) || 0;
      this.curPenStroke = this.penStrokeArray[
        Math.abs(parseInt(((this.blockId % 10) - 1) / 3))
      ];
      // 获取canvasDom，然后初始化写字器
      const res = await this.getCanvasDom(this.$refs.hanziWriter);
      // 实例内无法同步获取canvas实例，导致移动端报错，提取获取并赋值给节点
      this.$refs.hanziWriter.ctx = res.ctx;
      this.$refs.hanziWriter.canvasInstance = res.canvasInstance;
      // 创建画用户轨迹时的可加载图片
      const img = res.canvasInstance.createImage();
      img.src = this.curPenStroke.url;
      this.curPenStroke.imageData = img;

      // 写字主要配置
      const writer = new HanziWriter(this.$refs.hanziWriter, {
        character: title,
        charDataLoader: (char, onload, onError) => {
          uni.request({
            url: `https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-write/data/${encodeURIComponent(
              char
            )}.json`,
            success: (res) => {
              onload(res.data);
            },
          });
        },
        /**无限制，性能问题已经优化 */
        quizInterval: 1,
        keepUserStrokeAfterSuccess: true,
        highlightOnComplete: false,
        highlightColor: "#3FC6FF",
        showHintAfterMisses: 1,
        leniency: 1,
        checkSingleStroke: true,
        miniDistance: 8,
        drawUserStrokeAction: (ctx, points) => {
          if (points.length === 1 && !points[0]) return;
          points.forEach((point) => {
            const width = this.curPenStroke.width;
            const height = this.curPenStroke.height;
            ctx.drawImage(
              this.curPenStroke.imageData,
              point.x - width / 2,
              point.y - height / 2,
              width,
              height
            );
          });
        },
        addPoint: (data) => {
          //处理补点问题
          if (!this.perPoint) {
            this.perPoint = data;
          }
          let retData = [data];
          const gapX = this.perPoint.x - data.x;
          const gapY = this.perPoint.y - data.y;
          const gapdIstance = Math.sqrt(Math.pow(gapX, 2) + Math.pow(gapY, 2));
          if (Math.abs(gapY) > 16 && Math.abs(gapY) > 16) {
            if ((gapX < 0 && gapY < 0) || (gapX > 0 && gapY > 0)) {
              retData.unshift({
                x: this.perPoint.x - Math.abs(gapX) / 2,
                y: this.perPoint.y - Math.abs(gapY) / 2,
              });
            } else {
              retData.unshift({
                x: this.perPoint.x - Math.abs(gapX) / 2,
                y: this.perPoint.y + Math.abs(gapY) / 2,
              });
            }
          } else {
            if (Math.abs(gapX) > 16) {
              retData.unshift({
                x: this.perPoint.x + Math.abs(gapX) / 2,
                y: this.perPoint.y,
              });
            }
            if (Math.abs(gapY) > 16) {
              retData.unshift({
                x: this.perPoint.x,
                y: this.perPoint.y + Math.abs(gapY) / 2,
              });
            }
          }
          this.perPoint = data;
          return retData;
        },
      });

      // 写字各个阶段主逻辑
      let self = this;
      writer.quiz({
        onComplete: (data) => {
          console.log("complete", data);
          this.$emit("changeFlashStatus", 3);
          wx.canvasToTempFilePath({
            canvas: this.$refs.hanziWriter.canvasInstance,
            width: 270,
            height: 270,
            success: (res) => {
              console.log(
                "上传图片上传图片上传图片上传图片上传图片上传图片",
                res
              );
              clearInterval(this.animeTimer);
              // todo:完成汉字回调，需要补充提交相关的逻辑
              console.log("userStroke", this.userStrokes);
              setTimeout(() => {
                this.deletDelay();
                this.submit(res.tempFilePath);
              }, 2000);
            },
            fail: (error) => {
              console.log(error);
            },
          });
        },
        onStartStroke: (data) => {
          console.log("onStartStroke", data);
          const curStroke = data.characterStrokes[data.strokeNum];
          this.animeDelay(curStroke.wrapperAxisPoints);
        },
        onStartUserStroke: (data) => {
          console.log(
            "onStartUserStroke开始写了开始写了开始写了开始写了开始写了",
            data
          );
          this.animeShow = false;
          clearInterval(this.animeTimer);
        },
        onCorrectStroke: (data) => {
          this.userStrokes.push(data.drawnPath);
          const nextStroke = data.characterStrokes[data.strokeNum + 1];
          if (nextStroke) {
            this.animeDelay(nextStroke.wrapperAxisPoints);
          }
          console.log("onCorrectStroke,写对了，写对了 ");
          this.perPoint = null;
          // todo: 播放声音，动效
          this.handleStrokeFn(true);
        },
        onMistake: (data) => {
          console.log("onMistake,写错了，写错了 ");
          const curStroke = data.characterStrokes[data.strokeNum];
          this.animeDelay(curStroke.wrapperAxisPoints);
          this.perPoint = null;

          // todo： 播放声音，动效
          this.handleStrokeFn();
        },
      });
      writer.hideCharacter();
      this.writer = writer;
    },
    // 绘制效果处理
    handleStrokeFn(isCorrect) {
      this.handleDelayFn();
      this.$emit("changeFlashStatus", isCorrect ? 1 : 2);
      //写对提示音
      this.innerAudioContext.src = `https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-write/${
        isCorrect ? "right_sound" : "wrong_tone"
      }.mp3`;
      this.innerAudioContext.play();
      if (!isCorrect) {
        this.isWonderful = isCorrect;
      }
    },
    // 画笔动画
    startDrawAnime(points) {
      points.forEach((point, index) => {
        this.animation.translate(point.x, point.y).step({ duration: 300 });
        if (index === 0) this.animation.opacity(1).step({ duration: 300 });
      });
      this.animation.opacity(0).step({ duration: 300 });
      this.penAnimeData = this.animation.export();
      // 清空动画变量，以便下次触发
      setTimeout(() => {
        this.penAnimeData = null;
      }, this.animeOption.duration * (points.length + 2));
    },

    submit(writeImg) {
      // 进行数据上传处理;
      let self = this;
      console.log(`[调用] wx.uploadFile, data:`, writeImg);
      wx.uploadFile({
        // url: "http://kidaction-docker.suanshubang.com/kid-chinese/inclass/audioupload",
        url: "https://yuwen.zybang.com/kid-chinese/inclass/audioupload",
        filePath: writeImg,
        name: "audioFile",
        header: {
          "content-type": "multipart/form-data",
        },
        success: function(res) {
          console.log(`SDK uploadFile Successssss`, res);
          const data = JSON.parse(res.data);
          console.log("uploadFile imgUrl", data.data.url);
          //处理canvas动画
          const userKv = {
            standardAnswer: self.question.title,
            writingFile: self.userStrokes,
          };
          const submitObj = {
            type: self.question.category,
            userKv: userKv,
          };
          const answerRecordSubmit = {
            type: self.question.category,
          };
          // 答题记录
          const answerRecordObj = {
            tidId: self.question.tid,
            tidType: self.question.category,
            isCorrect: 1,
          };
          // 提交数据
          const answerData = {},
            tidData = { isSign: 1, correct: 1 };
          tidData.answer = [data.data.url];
          tidData.duration = parseInt((+new Date() - self.startTime) / 1000);
          tidData.userKv = [];
          answerData[self.question.tid] = tidData;
          // answerData[1200240356] = tidData;
          submitObj.answerData = answerData;
          // 激励首次/非首次答对
          submitObj.first = self.isWonderful ? 1 : 0;
          answerRecordObj.answerData = answerData;
          answerRecordSubmit.answerData = answerRecordObj;
          self.$emit("nextQuestion", submitObj, self.isWonderful);
          self.$emit("answerRecord", answerRecordSubmit);
        },
        fail: function(res) {
          if (res) {
            console.log(`SDK uploadFile fail`, res);
          }
        },
        complete: function(res) {
          console.log(`SDK uploadFile complete`, res);
        },
      });
    },

    //处理写字部分定时器
    handleDelayFn() {
      this.deletDelay();
      //三秒提示未作答
      this.intervalWarnTimer = setTimeout(() => {
        this.innerAudioContext1 = wx.createInnerAudioContext();
        this.innerAudioContext1.src = this.intervalWarnArray[
          Math.floor(Math.random() * 4)
        ].url;
        this.innerAudioContext1.play();
      }, 3000);
    },
    animeDelay(points) {
      this.animeShow = true;
      clearInterval(this.animeTimer);
      this.animeTimer = null;
      this.penAnimeData = null;
      setTimeout(() => {
        this.startDrawAnime(points);
      }, 0);
      this.animeTimer = setInterval(() => {
        this.startDrawAnime(points);
      }, this.animeOption.duration * (points.length + 4));
    },

    deletDelay() {
      clearTimeout(this.intervalWarnTimer);
      this.intervalWarnTimer = null;
      this.innerAudioContext1 = null;
    },
  },

  destroyed() {
    this.innerAudioContext = null;
    this.innerAudioContext1 = null;
  },
};
</script>
<style lang="scss" scoped>
@import "../../static/css/yaya-mixin.scss";
.write-box {
  width: 100vw;
  height: 100vh;
  display: flex;
  flex-direction: column;
  // justify-content: flex-end;
  .write-container {
    width: 100vw;
    height: auto;
    // justify-content: center;
    box-sizing: border-box;
    display: flex;
    align-items: flex-end;
    margin-top: tovmin(128);
    position: relative;
    .right {
      @include w_h(432, 432);
      border-radius: tovmin(24);
      text-align: left;
      .canvas-wrapper {
        @include v_w_h_center(540, 540);
        position: relative;
        width: 270px;
        height: 270px;
        .anime-mask {
          width: 100%;
          height: 100%;
          pointer-events: none;
          top: 0;
          left: 0;
          position: absolute;

          .animate-draw {
            pointer-events: none;
            opacity: 0;
            top: -17%;
            left: -30px;
            width: 80px;
            height: 57px;
            position: relative;
            .animate-draw-pen {
              position: absolute;
              right: 0;
              top: 0;
              pointer-events: none;
              width: 57px;
              height: 57px;
              z-index: 1;
              position: absolute;
            }
            .animate-draw-lizi {
              position: absolute;
              left: 0;
              bottom: 0;
              pointer-events: none;
              width: 50px;
              height: 50px;
              bottom: -15px;
              position: absolute;
              background: url("https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-write/yaya_lizi.png");
              background-size: cover;
              animation: yy-test-animation 1.5s steps(20) infinite;
            }
          }
        }
      }
    }
  }
  @keyframes yy-test-animation {
    0% {
      background-position-x: 0;
    }
    100% {
      background-position-x: -2000%;
    }
  }
}
</style>
