<!-- 录音按钮组件 -->
<template>
  <view>
    <view class="reading_components" :class="{ isPad: isPad }">
      <view class="r_c_bottom">
        <view class="r_c_b_btn">
          <view class="wave_img_wrapper">
            <view
              class="wave_img wave_img_left"
              :class="{ auto_play: recordingStatus }"
            ></view>
          </view>
          <view class="btn_img_wrapper" @tap="bottomBtnTap(index)">
            <view class="readyCheckBtn" v-if="readyCheck"></view>
            <!--start 进度圆环-->
            <canvas
              class="canvas"
              id="canvasWrap"
              canvas-id="canvasWrap"
            ></canvas>
            <view class="btn_img btn_m" v-if="!readyCheck">
              <view
                v-if="question.category === 95 && showTips"
                class="hande_guide"
              ></view>
              <view
                v-if="question.category === 95 && isListening"
                class="listeningBtn"
              ></view>
              <view
                v-if="question.category === 95 && !isListening"
                :class="btnBg"
              ></view>
              <view v-if="question.category !== 95" class="listening_container">
                <view class="pendingView" v-if="pendingView"></view>
                <view
                  v-else
                  class="microphone_common"
                  :class="{
                    breathing_effect:
                      backgroundType === 'breathing' ||
                      backgroundType === 'still',
                    listening_effect: backgroundType === 'listening',
                    pauseing_effect: backgroundType === 'pauseing',
                    auto_play: backgroundType !== 'still',
                  }"
                ></view>
              </view>
            </view>
          </view>
          <view class="wave_img_wrapper">
            <view
              class="wave_img wave_img_right"
              :class="{ auto_play: recordingStatus }"
            ></view>
          </view>
        </view>
      </view>
    </view>
    <!-- 录音权限授权引导蒙层 -->
    <record-auth v-if="showAuth" @callback="authCallback" />
  </view>
</template>

<script>
import { mapState, mapMutations } from "vuex";
import vSdk from "../js/audioSdkInstance.js";
import RecordAuth from "./record-auth.vue";
import { islock } from "../js/lock.js";

export default {
  props: {
    question: {
      type: Object,
      default: {},
    },
    clearCountDown: {
      type: Object,
      default: {},
    },
    isPad: {
      type: Boolean,
      default: false,
    },
  },
  data() {
    return {
      progress_txt: "中200upx...",
      count: 0, // 设置 计数器 初始为0
      countTimer: null, // 设置 定时器 初始为null
      ctx: null,
      context: null,
      RecManager: null,
      readingTimer: null,
      // 展示去授权
      showAuth: false,
      // 小手动画标识
      showTips: false,
      // 小手动画定时器
      showTipsTimer: null,
      // vSdk: null,
      changingRecBtn: false,
      // recordRes: {}, //数据接口见 http://wiki.zuoyebang.cc/pages/viewpage.action?pageId=31522740#
      startRecordTime: 0, // 开始录音时间
      recordDuration: 0, //录音持续的时间
      stopCountDown: false, // 是否暂停圆环倒计时,
      questionTitleArr: [], // 展示的title数组并添加状态 为了实现KTV字幕效果
      gushiIndex: 0, // 当前进行到古诗的第几句,
      repeatAfterCanSubmit: false, // 开放口述提是否可以提交   开放口述要手动点击进行提交
      gushiAverageScore: 0, // 古诗提交时的分数  取四句古诗的平均分
      gushiDuration: 0, // 古诗答题的持续时间  需要各句古诗相加
      gushiUploadFileUrl: "", // 古诗进行提交时的临时地址
      isReStart: false,
      isListening: true,
      readyCheck: false,
      stopWaitingIsFinnal: null,
      dingTimeOut: null,
    };
  },
  watch: {
    clearCountDown(params) {
      console.log("监听到clearCountDown", params);
      clearTimeout(this.showTipsTimer);
      clearTimeout(this.dingTimeOut);
      this.clearCanvas();
      this._innerAudioContext[this.gushiIndex] &&
        this._innerAudioContext[this.gushiIndex].stop();
      this._innerAudioContext = [];
      this.gushiIndex = 0;
      this.recordDuration = 0;
      this.isReStart = true;
      this.gushiDuration = 0;
      this.readyCheck = false;
      this.isListening = true;
      this.gushiAverageScore = 0;
      this.stopWaitingIsFinnal = null;
      clearTimeout(this.gushiReadingTimer);
      clearTimeout(this.readingTimer);
      this.handAudioContext && this.handAudioContext.stop();
      if (params.type == "stop") {
        // 出现蒙层 停止语音SDK
        console.log("params.type == stop");
        vSdk.stop();
        this.showTips = false;
      }
    },
  },
  created() {
    this._audioEnd = this.audioEnd.bind(this);
    // 古诗播放音频的实例对象数组
    this._innerAudioContext = [];

    let arr = this.question.title.split("");
    // 把初始每个文字的状态都设置为normal
    this.questionTitleArr = arr.map((item) => {
      return {
        status: "normal",
        text: item,
      };
    });
    this.dingAudioContext = wx.createInnerAudioContext();
    this.dingAudioContext.src =
      "https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-audio/audio_ding_start.mp3";
  },
  components: {
    RecordAuth,
  },
  computed: {
    ...mapState("quizInClass", [
      "STEPENUMS",
      "CATEGORYENUMS",
      "AUDIOTYPENUMS",
      "IMGRESOUCES",
      "step",
      "audioPlayStatus",
      "recordingStatus",
      "recordRes",
    ]),
    // 开放口述题 按钮样式
    btnBg() {
      const { step, STEPENUMS, IMGRESOUCES } = this;
      let moving = this.changingRecBtn ? "moving" : "";
      switch (step) {
        case STEPENUMS.Record:
          return `new_btn_sprit final ${moving}`;
        case STEPENUMS.Pending:
          return `new_btn_sprit Pending`;
        default:
          return `new_btn_sprit huatong ${moving}`;
      }
    },
    pendingView() {
      const { step, STEPENUMS } = this;
      switch (step) {
        case STEPENUMS.Pending:
          return true;
        default:
          return false;
      }
    },
    // 古诗背诵&单句跟读 按钮样式
    backgroundType() {
      const { question, step, STEPENUMS, audioPlayStatus } = this;
      if (question.category === 96 || question.category === 97) {
        console.log(step, STEPENUMS, audioPlayStatus);
        switch (step) {
          case STEPENUMS.Listen:
            if (audioPlayStatus) {
              return "breathing";
            } else {
              return "listening";
            }
          case STEPENUMS.Record:
            return "listening";
          case STEPENUMS.Pause:
            return "pauseing";
          default:
            return "still";
        }
      } else {
        switch (step) {
          case STEPENUMS.Start:
            return "breathing";
          case STEPENUMS.Listen:
            return "listening";
          case STEPENUMS.Record:
            return "listening";
          default:
            return "still";
        }
      }
    },
  },
  methods: {
    ...mapMutations("quizInClass", [
      "updateRecordRes",
      "updateStep",
      "updateRecordingStatus",
    ]),
    // 语音授权回调
    authCallback(res) {
      if (res) {
        // 语音权限获取成功，隐藏授权蒙层并开始录音
        this.startRecord();
        this.showAuth = false;
      } else {
        // 语音权限获取失败，继续展示蒙层
        this.showAuth = true;
      }
    },
    // 开场引导音频播放结束
    audioEnd() {
      console.log("音频播放结束", this.step);
      const delay = 10;
      this.isListening = false;
      if (this.step < this.STEPENUMS.Record) {
        /**开放口述题 展示呼吸态 todo*/
        if (this.question.category == this.CATEGORYENUMS.RepeatAfter) {
          // 5s小手提示，引导按钮点击
          this.showTipsTimer = setTimeout(() => {
            this.showTips = true;
            console.log("----------出现小手播放随机音频---------");
            let num = Math.floor(Math.random() * 5 + 1);
            this.handAudioContext = wx.createInnerAudioContext();
            this.handAudioContext.src = `https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-audio/RepeatAfterHandAudio${num}.mp3`;
            setTimeout(() => {
              // 小手动画立刻出现  但是语音提示5s后出
              if (this.step < this.STEPENUMS.Record) {
                this.handAudioContext.play();
              }
            }, 0);
          }, 3000);
        } else if (
          this.question.category == this.CATEGORYENUMS.SingleReading ||
          this.question.category == this.CATEGORYENUMS.PeomReading
        ) {
          /**单句朗读&古诗背诵 题目读完0.5秒后, 自动变为录音态 todo */
          setTimeout(() => {
            this.recordAuthCheck();
          }, delay);
        }
      }
    },
    // 录音权限检查
    recordAuthCheck() {
      console.log("录音权限检查");
      let self = this;
      let userAllowRecord = wx.getStorageSync("userAllowRecord");
      if (userAllowRecord) {
        // 用户已经授权过录音权限
        self.startRecord();
      } else {
        // 用户还未授权录音 调起录音授权
        /**获取授权 */
        wx.getSetting({
          success(res) {
            if (!res.authSetting["scope.record"]) {
              wx.authorize({
                scope: "scope.record",
                success() {
                  /*调用评测SDK*/
                  console.log(
                    `用户已经同意小程序使用录音功能,开始录音111----------------->`
                  );
                  self.startRecord();
                  wx.setStorageSync("userAllowRecord", true);
                },
                fail() {
                  console.log("----------拒绝授权--------------");
                  self.updateStep(self.STEPENUMS.Start);
                  self.showAuth = true;
                },
              });
            } else {
              /*调用评测SDK*/
              self.startRecord();
              wx.setStorageSync("userAllowRecord", true);
            }
          },
        });
      }
      this.startRecordTime = +new Date();
      console.log("录音权限检查recordAuthCheck当前时间", this.startRecordTime);
      clearTimeout(self.showTipsTimer);
      self.showTips = false;
    },
    // 底部录音按钮
    bottomBtnTap(index) {
      if (islock("bottomBtnTap")) {
        return;
      }
      if (this.question.category == this.CATEGORYENUMS.PeomReading) {
        return;
      }
      if (this.audioPlayStatus || this.step == this.STEPENUMS.Pending) {
        console.log(
          `音频播放中,点击了底部按钮... category ${this.question.category}`
        );
        return;
      }
      if (!this.recordingStatus) {
        // 检查录音权限
        console.log("检查录音权限");
        this.recordAuthCheck();
        this.handAudioContext && this.handAudioContext.stop();
      } else {
        if (this.question.category == this.CATEGORYENUMS.RepeatAfter) {
          if (+new Date() - this.startRecordTime < 2000) {
            console.log(`没超过2s点不了------->`);
            return;
          }
          console.log("开放口述停止录音");
          this.updateStep(this.STEPENUMS.Pending);

          setTimeout(() => {
            this.stopVoiceTest();
          }, 300);
        } else if (this.question.category == this.CATEGORYENUMS.SingleReading) {
          console.log("单独跟读点击按钮   停止录音");
          this.updateStep(this.STEPENUMS.Pending);
          setTimeout(() => {
            this.stopVoiceTest();
          }, 300);
        }
      }
    },

    // 开始录音触发函数
    startRecord() {
      if (this.question.category == this.CATEGORYENUMS.RepeatAfter) {
        this.changingAction();
      }
      console.log("开始录音触发函数");
      if (this.question.category == this.CATEGORYENUMS.PeomReading) {
        // 古诗进入古诗的播放逻辑  放一句停一句再放下一句
        console.log(
          "古诗进入古诗的播放逻辑  题目放一句 学生答一句  再放下一句"
        );
        this.gushiStartVoiceTest();
      } else {
        // 开放口述和单句跟读逻辑 只播放一次 语音SDK监听一次
        console.log("进入开放口述和单句的播放逻辑");
        this.startVoiceTest();
        let limitTime = parseInt(this.question.answerTime);
        // 跟读题延迟题目时间，未返回结果等待60s停止录音
        limitTime =
          this.question.category == this.CATEGORYENUMS.SingleReading
            ? limitTime >= 60
              ? 60
              : limitTime
            : limitTime;
        if (limitTime && this.recordingStatus) {
          this.readingTimer = setTimeout(() => {
            console.log("结束录音动作");
            this.stopVoiceTest();
          }, limitTime * 1000);
        }
      }
    },

    // 单句跟读和开放口述开始录音动作
    startVoiceTest() {
      if (this.question.category == this.CATEGORYENUMS.SingleReading) {
        console.log("ding音频播放  当前时间", +new Date());
        this.dingAudioContext.play();
      }
      this.updateStep(this.STEPENUMS.Record);
      this.updateRecordingStatus(true);
      // 开始canvas圆环倒计时
      this.createCanvasCxt(this.question.answerTime);
      /**单句朗读题  开放口述 调用自研评测SDK */
      console.log(`[开始录音] 单句跟读 || 开放口述---------->`);
      console.log("question", this.question);
      // audioType  开放口述是QNA  4    单句跟读是Sentence 2
      let startAudioText = "";
      if (this.question.category == this.CATEGORYENUMS.RepeatAfter) {
        startAudioText = this.question.description.split("、");
      } else {
        startAudioText = this.question.title;
      }
      this.dingTimeOut = setTimeout(() => {
        vSdk.start(
          {
            audioText: startAudioText,
            audioType:
              this.question.category == this.CATEGORYENUMS.RepeatAfter
                ? this.AUDIOTYPENUMS.QNA
                : this.AUDIOTYPENUMS.Sentence,
          },
          this.isReStart
        );
        vSdk.onResult((res) => {
          console.log("开放和单句检测到onresult", res);
          let changeWordArr = res.wordList.map((item) => {
            return {
              status: +item.score > 0 ? "correct" : "wrong",
              text: item.word,
            };
          });
          this.$emit("changeWord", {
            changeWordArr: changeWordArr,
            type: "SingleReading",
          });

          if (res.should_stop == 1) {
            console.log("----------单句和开放res.should_stop----------", res);
            if (this.question.category == this.CATEGORYENUMS.SingleReading) {
              this.updateStep(this.STEPENUMS.Pending);
              this.stopVoiceTest();
            }
          }

          if (res.isFinnal) {
            console.log("----------结束录音动作res.Finnal----------", res);
            this.stopWaitingIsFinnal && clearTimeout(this.stopWaitingIsFinnal);
            this.readyCheck = true;
            this.updateRecordRes({
              beginTime: new Date().getTime(),
              online_audio_url: res.online_audio_url_mp3,
              score: res.score,
              length_ms: parseInt(Number(res.length_ms) / 1000),
            });
            this.clearCanvas();

            setTimeout(() => {
              if (this.question.category == this.CATEGORYENUMS.SingleReading) {
                // 单句跟读直接提交
                console.log("单句跟读触发提交");
                this.updateStep(this.STEPENUMS.Check);
              } else {
                // 开放口述需要点击底部按钮才进行提交
                if (this.repeatAfterCanSubmit) {
                  this.updateStep(this.STEPENUMS.Check);
                }
              }
            }, 1000);
          }
        });
      }, 500);
    },

    // 古诗开始录音动作
    gushiStartVoiceTest() {
      console.log(
        "古诗开始录音动作  this._innerAudioContext",
        this._innerAudioContext
      );
      console.log("古诗开始录音动作  this.question", this.question);
      console.log("古诗开始录音动作  this.gushiIndex", this.gushiIndex);
      this.$emit(
        "gushiChange",
        // this.question.poetry.fields[this.gushiIndex].fieldImage.url
        this.gushiIndex
      );
      this._innerAudioContext.push(wx.createInnerAudioContext());
      this._innerAudioContext[this.gushiIndex].autoplay = false;
      this._innerAudioContext[
        this.gushiIndex
      ].src = this.question.poetry.fields[this.gushiIndex].fileAudio.url;
      this._innerAudioContext[this.gushiIndex].play();
      this._innerAudioContext[this.gushiIndex].onEnded(() => {
        console.log("检测到语音播放完毕 开始录音   进入语音检测");
        this.gushiCheckAudio();
        let overtime = parseInt(
          this.question.poetry.fields[this.gushiIndex].fieldAnswerTime
        );
        overtime = overtime > 60 ? 60 : overtime;
        if (overtime && this.recordingStatus) {
          this.gushiReadingTimer = setTimeout(() => {
            console.log("倒计时结束  古诗结束录音动作");
            this.gushiStopVoiceTest();
          }, overtime * 1000);
        }
      });
    },

    // 古诗检测语音SDK函数
    gushiCheckAudio() {
      console.log("[开始录音] 古诗----gushiIndex------>", this.gushiIndex);
      console.log("question", this.question);
      this.updateStep(this.STEPENUMS.Listen);
      this.updateRecordingStatus(true);
      // 开始canvas圆环倒计时
      setTimeout(() => {
        this.createCanvasCxt(
          this.question.poetry.fields[this.gushiIndex].fieldAnswerTime
        );
      }, 0);
      /** 古诗 调用自研评测SDK */
      console.log(
        "this.question.poetry.fields[this.gushiIndex].text",
        this.question.poetry.fields[this.gushiIndex].text
      );
      if (+this.gushiIndex === 0) {
        // 第一次播放调用start 后续调用resume
        console.log("第一次播放调用start   this.isReStart", this.isReStart);
        console.log(
          "this.question.poetry.fields[this.gushiIndex].text",
          this.question.poetry.fields[this.gushiIndex].text
        );
        vSdk.start(
          {
            audioText: this.question.poetry.fields[this.gushiIndex].text,
            audioType: this.AUDIOTYPENUMS.Sentence,
          },
          this.isReStart
        );
        vSdk.onResult((res) => {
          console.log("古诗检测到onResult", res);
          let changeWordArr = res.wordList.map((item) => {
            return {
              status: +item.score > 0 ? "correct" : "wrong",
              text: item.word,
            };
          });
          this.$emit("changeWord", {
            changeWordArr: changeWordArr,
            type: "PeomReading",
            peomIndex: this.gushiIndex,
          });

          if (res.should_stop == 1 && res.isReceiving) {
            // this.updateStep(this.STEPENUMS.Pending);
            this.gushiStopVoiceTest();
          }

          if (res.isFinnal) {
            console.log(
              `----------古诗检测到isFinnal 触发resume-----${this.gushiIndex}-----`,
              res
            );

            this.gushiIndex++;
            this.gushiAverageScore += res.score;
            this.gushiDuration += parseInt(Number(res.length_ms) / 1000);

            if (this.gushiIndex < this.question.poetry.fields.length) {
              console.log("gushiIndex < 4  继续播放下一句古诗音频");
              this.gushiStartVoiceTest();
            } else {
              console.log("最后一句古诗录音完毕 进行提交", res);
              console.log("this.gushiUploadFileUrl", this.gushiUploadFileUrl);
              this.readyCheck = true;
              this.stopWaitingIsFinnal &&
                clearTimeout(this.stopWaitingIsFinnal);
              setTimeout(() => {
                this.updateRecordRes({
                  beginTime: new Date().getTime(),
                  online_audio_url: this.gushiUploadFileUrl,
                  score: Math.floor(
                    this.gushiAverageScore / this.question.poetry.fields.length
                  ),
                  length_ms: this.gushiDuration,
                });
                this.clearCanvas();
                this.updateStep(this.STEPENUMS.Check);
              }, 1000);
            }
          }
        });
      } else if (0 < +this.gushiIndex < this.question.poetry.fields.length) {
        console.log("后续播放调用resume");
        vSdk.resume({
          audioText: this.question.poetry.fields[this.gushiIndex].text,
          audioType: this.AUDIOTYPENUMS.Sentence,
        });
      }
    },

    // 古诗结束录音动作
    gushiStopVoiceTest() {
      // this.updateStep(this.STEPENUMS.Pause);
      if (islock("gushiStopVoiceTest")) {
        return;
      }
      console.log("监听到古诗进行暂停");
      // 进行暂停并播放下一句的语音，等下一句的语音播放完毕之后调用resume继续监听
      clearTimeout(this.gushiReadingTimer);
      this.stopCountDown = true; // 暂停圆环倒计时
      this.clearCanvas();
      // 全局更改是否正在录音  recordingStatus
      this.updateRecordingStatus(false);
      if (this.gushiIndex < this.question.poetry.fields.length - 1) {
        console.log("pause  暂停语音SDK");
        this.updateStep(this.STEPENUMS.Pause);
        vSdk.pause();
      } else {
        console.log("stop   停止语音SDK");
        this.updateStep(this.STEPENUMS.Pending);
        vSdk.stop((res) => {
          this.gushiUploadFileUrl = res.tempFilePath;
        });
        this.uploadIssue();
      }
    },

    // 结束录音动作
    stopVoiceTest() {
      console.log("单句和开放结束录音动作");
      if (islock("stopVoiceTest")) {
        return;
      }
      if (this.question.category == this.CATEGORYENUMS.RepeatAfter) {
        this.repeatAfterCanSubmit = true;
      }
      clearTimeout(this.readingTimer);
      this.stopCountDown = true; // 暂停圆环倒计时
      this.clearCanvas();
      console.log(
        `[阅读类题型 结束录音]-------------> category:${this.question.category}`
      );

      vSdk.stop();
      this.uploadIssue();
      // 全局更改是否正在录音  recordingStatus
      this.updateRecordingStatus(false);
      vSdk.onError(() => {
        console.log(`[销毁 vSdk]--------------------> `);
        // vSdk.destroy();
      });
    },

    uploadIssue() {
      if (!this.stopWaitingIsFinnal) {
        let wx_user = uni.getStorageSync("wx_user")
          ? uni.getStorageSync("wx_user")
          : "-1";
        this.stopWaitingIsFinnal = setTimeout(() => {
          console.log("等待isfinnal");
          let resultData = {
            code: 11111,
            client: 2,
            from: "fe",
            content: JSON.stringify({
              errorText: "请求语音测评没有返回isfinnal",
              user: wx_user,
            }),
          };
          this.$http
            .pro_post(
              "https://yuwen.zybang.com/mainstation/tool/uploadIssue",
              resultData
            )
            .then(
              (res) => {
                console.log("上报异常接口请求成功", res);
              },
              (err) => {
                console.log(err);
              }
            );
        }, 6000);
      }
    },

    // 点击录音按钮动效转换
    changingAction() {
      let self = this;
      self.changingRecBtn = true;
      setTimeout(() => {
        self.changingRecBtn = false;
      }, 800);
    },
    /** 圆环canvas动画相关 */
    createCanvasCxt(answerTime) {
      console.log("触发canvas倒计时圆环");
      let circleColor = "";
      if (this.question.category == this.CATEGORYENUMS.RepeatAfter) {
        circleColor = "#FBE2BA";
      } else {
        circleColor = "#C1E2EE";
      }
      this.stopCountDown = false;
      let _this = this;
      let cw;
      let ch;
      let cr;
      const query = wx.createSelectorQuery().in(_this);
      query
        .select("#canvasWrap")
        .boundingClientRect(function(rect) {
          //监听canvas的宽高
          cw = parseInt(rect.width / 2); //获取canvas宽的的一半
          ch = parseInt(rect.height / 2); //获取canvas高的一半，
          cr = parseInt((rect.height - 6) / 2); //获取canvas高的一半，
        })
        .exec();
      // 使用 wx.createCanvasContext 获取绘图上下文 context   自定义组件需要传this
      const ctx = wx.createCanvasContext("canvasWrap", _this);
      // console.log("ctx", ctx);
      let imd = null;
      let circ = Math.PI * 2;
      let quart = Math.PI / 2;

      ctx.beginPath();
      ctx.setLineCap("square");
      ctx.closePath();
      ctx.fill();

      imd = wx.canvasGetImageData({
        canvasId: "canvasWrap",
        x: 0,
        y: 0,
        width: 240,
        height: 240,
        success(res) {
          // console.log("res", res);
        },
      });
      const cdata = new Uint8ClampedArray([255, 0, 0, 1]);
      function draw(current) {
        wx.canvasPutImageData({
          canvasId: "canvasWrap",
          x: 0,
          y: 0,
          width: 1,
          height: 1,
          data: imd,
          success(res) {
            // console.log("res", res);
          },
        });
        ctx.setLineWidth((10 / 166) * cw * 2);
        ctx.setStrokeStyle(circleColor);
        ctx.beginPath();
        ctx.setLineCap("square");
        ctx.arc(cw, ch, cr, -quart, circ * current - quart, false);
        ctx.stroke();
        ctx.draw();
      }
      // _this.recordDuration = 0.01 * (2 / answerTime);
      _this.recordDuration = 0;
      function loadCanvas(now) {
        let timer = setInterval(function() {
          if (_this.recordDuration > now) {
            draw(_this.recordDuration); //最后一次绘制
            clearInterval(timer);
            console.log("最后一次绘制");
          } else {
            if (!_this.stopCountDown) {
              draw(_this.recordDuration);
              _this.recordDuration += 0.01 * (2 / answerTime);
            } else {
              clearInterval(timer);
              console.log("暂停绘制");
              _this.stopCountDown = false;
            }
          }
        }, 20);
      }
      setTimeout(() => {
        loadCanvas(1);
      }, 1000);
    },
    clearCanvas() {
      this.stopCountDown = true; // 暂停圆环倒计时
      let _this = this;
      const ctx = wx.createCanvasContext("canvasWrap", _this);
      ctx.clearRect(0, 0, 300, 300);
      ctx.draw();
      console.log("清除圆环倒计时");
    },
  },
  destory() {
    // this.RecManager
    vSdk.destroySdk();
  },
};
</script>

<style lang="scss" scoped>
@import "../../../static/css/mixin.scss";
@import "../../../static/css/yaya-mixin.scss";

.reading_components {
  @extend .posCenter;
  /* top: tovmin(594); */
  top: tovmin(630);
  &.isPad {
    top: tovmin(800);
  }
  .r_c_bottom {
    .r_c_b_btn {
      width: tovmin(540);
      @extend .flexSpaceBetween;
      align-items: center;
      .wave_img_wrapper {
        @include WH(tovmin(140), tovmin(100));
        overflow: hidden;
        .wave_img {
          height: tovmin(100);
          background-size: auto 100%;
          background-position-x: 0%;
          background-repeat: no-repeat;
          visibility: hidden;
          &.auto_play {
            visibility: visible;
            animation: elves-figure-animation 2.18s steps(137) infinite;
          }
        }
        .wave_img_left {
          background-image: url("https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-choice/wave_img_left.png");
        }
        .wave_img_right {
          background-image: url("https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-choice/wave_img_right.png");
        }
      }
      .btn_img_wrapper {
        position: relative;
        .readyCheckBtn {
          @include CircleView(tovmin(162));
          overflow: hidden;
          background-image: url("https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-audio/btnReadyCheckSprite.png");
          background-size: cover;
          animation: btn-readyCheck-animation 1s steps(13) 1 forwards;
        }
        .canvas {
          @include WH(tovmin(166), tovmin(166));
          /* @include WH(tovmin(160), tovmin(160)); */
          position: absolute;
          top: tovmin(0);
          left: tovmin(0);
          /* z-index: 9; */
        }
        @extend .flexSpaceBetween;
        .btn_img {
          /* padding: tovmin(7); */
          padding: tovmin(10);
          background: $colorWhite;
          // overflow: hidden;
          position: relative;
          &.btn_m {
            display: flex;
            border-radius: 50%;
            image {
              /* @include WH(tovmin(130), tovmin(130)); */
              @include WH(tovmin(142), tovmin(142));
              /* @include WH(tovmin(136), tovmin(136)); */
            }
            .new_btn_sprit {
              @include CircleView(tovmin(142));
              overflow: hidden;
              background-image: url("https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-common/voice_sprites_new.png");
              background-size: cover;
              background-color: rgba(236, 236, 236, 1);
              &.moving {
                animation: yayaAnimation 0.8s steps(21) 1;
              }
              &.huatong {
                background-position-x: 0%;
              }
              &.final {
                background-position-x: 100%;
              }
              &.Pending {
                background-image: url("https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-audio/repeatPendingSprites.png");
                animation: btn-pending-animation 1s steps(19) infinite;
              }
            }
            .listeningBtn {
              @include CircleView(tovmin(142));
              overflow: hidden;
              background-image: url("https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-audio/yuyinListeningBtn.png");
              background-size: 100% 100%;
              background-color: #eee;
            }
          }
          &.btn_s {
            @include CircleView(tovmin(120));
          }
          .hande_guide {
            width: 60px;
            height: 60px;
            background: url("https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-audio/hand_point.png")
              no-repeat;
            background-size: auto 100%;
            animation: elves-figure-animation 1s steps(13, end) infinite;
            position: absolute;
            left: 43%;
            top: 38%;
          }
          .listening_container {
            /* @include WH(tovmin(130), tovmin(130)); */
            @include WH(tovmin(142), tovmin(142));
            overflow: hidden;
            //   解决 背景图片边缘毛边
            background-color: #2f6171;
            border-radius: 50%;
            position: relative;
            z-index: 1;
            .pendingView {
              @include WH(tovmin(142), tovmin(142));
              overflow: hidden;
              background-size: cover;
              background-image: url("https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-audio/btnPendingSprites.png");
              animation: btn-pending-animation 1s steps(19) infinite;
            }
            .microphone_common {
              /* height: 60px; */
              /* @include WH(tovmin(147), tovmin(120)); */
              @include WH(tovmin(198), tovmin(158));
              background-size: 100% 100%;
              background-image: url("https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-common/voice-tube-ani%20-big.png");
              /* position: absolute; */
              /* top: tovmin(51); */
              /* top: tovmin(0); */
              /* transform: translateY(tovmin(51)); */
              /* left: tovmin(-58); */
              transform: translate(tovmin(-58), tovmin(51));
            }
            .listening_effect {
              &.auto_play {
                /* top: tovmin(0); */
                /* transform: translateY(tovmin(0));
                transform: translateX(tovmin(-58)); */
                transform: translate(tovmin(-58), tovmin(0));
                animation: voice-tube-ani-to-top-animation 0.3s steps(25) 1,
                  voice-tube-ani-animation 1s steps(25) 0.3s infinite;
                /* animation: elves-figure-animation 1s steps(25) infinite; */
              }
            }
            .breathing_effect {
              &.auto_play {
                /* top: tovmin(51); */
                /* transform: translateY(tovmin(51));
                transform: translateX(tovmin(-58)); */
                transform: translate(tovmin(-58), tovmin(51));
              }
            }
            .pauseing_effect {
              animation: voice-tube-ani-to-pause-animation 0.6s ease-in 1;
            }
          }
        }
        .btn_sprite_wrapper {
        }
        .btn_sprite {
          /* @include CircleView(tovmin(142)); */
          @include CircleView(tovmin(130));
          overflow: hidden;
          background-image: url("https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/icons/55555.png");
          background-size: cover;
          background-position-x: 100%;
          /* animation: yayaAnimation 0.8s steps(5) 1; */
          animation: yayaAnimation 1s steps(5) 1;
        }
        @keyframes yayaAnimation {
          0% {
            background-position-x: -100%;
          }

          100% {
            background-position-x: 0%;
          }
        }
      }
    }
  }
}
@keyframes elves-figure-animation {
  0% {
    background-position-x: 0;
  }
  100% {
    background-position-x: 100%;
  }
}
@keyframes voice-tube-ani-to-top-animation {
  0% {
    /* top: tovmin(51); */
    /* transform: translateY(tovmin(51));
    transform: translateX(tovmin(-58)); */
    transform: translate(tovmin(-58), tovmin(51));
  }
  100% {
    /* top: tovmin(0); */
    /* transform: translateY(tovmin(0));
    transform: translateX(tovmin(-58)); */
    transform: translate(tovmin(-58), tovmin(0));
  }
}
@keyframes voice-tube-ani-to-pause-animation {
  0% {
    /* top: tovmin(0); */
    /* transform: translateY(tovmin(0));
    transform: translateX(tovmin(-58)); */
    transform: translate(tovmin(-58), tovmin(0));
  }
  20% {
    /* top: tovmin(51); */
    /* transform: translateY(tovmin(51));
    transform: translateX(tovmin(-58)); */
    transform: translate(tovmin(-58), tovmin(61));
  }
  40% {
    /* top: tovmin(51); */
    /* transform: translateY(tovmin(51));
    transform: translateX(tovmin(-58)); */
    transform: translate(tovmin(-58), tovmin(20));
  }
  60% {
    /* top: tovmin(35); */
    /* transform: translateY(tovmin(35));
    transform: translateX(tovmin(-58)); */
    transform: translate(tovmin(-58), tovmin(56));
  }
  80% {
    /* top: tovmin(35); */
    /* transform: translateY(tovmin(35));
    transform: translateX(tovmin(-58)); */
    transform: translate(tovmin(-58), tovmin(40));
  }
  100% {
    /* top: tovmin(51); */
    /* transform: translateY(tovmin(51));
    transform: translateX(tovmin(-58)); */
    transform: translate(tovmin(-58), tovmin(51));
  }
}
@keyframes voice-tube-ani-animation {
  0% {
    transform: translate(tovmin(-58), tovmin(0)) rotate(0deg);
    /* transform: rotate(0deg); */
    transform-origin: 0% 50%;
  }
  50% {
    transform: translate(tovmin(-58), tovmin(0)) rotate(8deg);
    /* transform: rotate(8deg); */
    transform-origin: 0% 50%;
  }
  100% {
    transform: translate(tovmin(-58), tovmin(0)) rotate(0deg);
    /* transform: rotate(0deg); */
    transform-origin: 0% 50%;
  }
}
@keyframes btn-readyCheck-animation {
  0% {
    background-position-x: 0;
    /* background-position-x: 0; */
  }
  100% {
    background-position-x: 100%;
  }
}
@keyframes btn-pending-animation {
  0% {
    background-position-x: 0;
  }
  100% {
    background-position-x: 100%;
  }
}
</style>
