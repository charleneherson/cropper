<!-- 录音完成回听&提交操作蒙层 -->
<template>
  <view class="reading_cover">
    <view class="r_c_top">
      <view class="r_c_t_record" @tap="playTempRecord()">
        <view class="record_icon">
          <image
            :src="IMGRESOUCES.playing_tiny_img"
            v-if="!tempRecordPlayStatus"
          />
          <image
            :src="IMGRESOUCES.playing_tiny_gif"
            v-if="tempRecordPlayStatus"
            class="tiny_gif"
          />
        </view>
        <view class="record_msg">
          <span class="record_msg_m">{{
            parseInt(this.recordRes.length_ms)
          }}</span>
          <span class="record_msg_s">s</span>
        </view>
      </view>
      <view class="r_c_t_btns">
        <view class="btn_item">
          <image
            class="r_w_icon_img"
            :src="IMGRESOUCES.icon_img_rollback"
            @tap="restart()"
          />
        </view>
        <view class="btn_item">
          <image
            class="r_w_icon_img"
            :src="IMGRESOUCES.icon_img_checked"
            @tap="submit()"
          />
        </view>
      </view>
    </view>
  </view>
</template>

<script>
import { mapState } from "vuex";

export default {
  data() {
    return {
      innerAudioContext: null,
      tempRecordPlayStatus: false, // 是否正在播放用户录入的音频
    };
  },
  computed: {
    ...mapState("quizInClass", ["IMGRESOUCES", "recordRes"]),
  },
  created() {
    // 创建音频上下文 & 监听事件
    this.innerAudioContext = wx.createInnerAudioContext();
    this.innerAudioContext.onPlay(() => {
      console.log(`用户临时录音 播放开始`);
      this.tempRecordPlayStatus = true;
    });
    this.innerAudioContext.onEnded((res) => {
      console.log(`用户临时录音 播放结束`);
      this.tempRecordPlayStatus = false;
    });
    this.innerAudioContext.onStop((res) => {
      console.log(`用户临时录音 播放终止`);
      this.tempRecordPlayStatus = false;
    });
  },
  methods: {
    // 点击播放用户的临时录音(适用于开放口述题/古诗背诵题)
    playTempRecord() {
      if (this.tempRecordPlayStatus) {
        console.log(`用户临时录音 点击结束`);
        this.innerAudioContext.stop();
      } else {
        console.log(`用户临时录音 点击开始`);
        this.innerAudioContext.src = this.recordRes.online_audio_url;
        this.innerAudioContext.play();
      }
    },
    // 点击重新录音按钮
    restart() {
      this.innerAudioContext.destroy();
      this.$emit("reset");
    },
    // 点击提交按钮
    submit() {
      this.innerAudioContext.destroy();
      this.$emit("submit", "complete");
    },
  },
};
</script>

<style lang="scss" scoped>
@import "../../../static/css/mixin.scss";

.reading_cover {
  position: fixed;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.8);
  z-index: 999;
  .r_c_top {
    width: 100%;
    // @extend .flexSpaceBetween;
    .r_c_t_record {
      @include WH(tovmin(366), tovmin(88));
      @extend .flexSpaceBetween;
      padding: 0 tovmin(36);
      margin: tovmin(215) auto tovmin(122);
      background: $colorWhite;
      border-radius: tovmin(44);
      .record_icon {
        margin-top: tovmin(22);
        padding: tovmin(2);
        @include WH(tovmin(34), tovmin(44));
        image {
          @include WH(tovmin(30), tovmin(40));
        }
        .tiny_gif {
          position: relative;
          left: tovmin(-8);
          @include WH(tovmin(45), tovmin(40));
        }
      }
      .record_msg {
        @include WH(6em, tovmin(60));
        text-align: right;
        color: $colorGray;
        .record_msg_m {
          font-size: tovmin(40);
        }
        .record_msg_s {
          font-size: tovmin(40);
          line-height: tovmin(88);
        }
      }
    }
    .r_c_t_btns {
      width: tovmin(440);
      display: flex;
      margin: 0 auto;
      @extend .flexSpaceBetween;
      .btn_item {
        @include WH(tovmin(140), tovmin(140));
        image {
          @include WH(tovmin(140), tovmin(140));
        }
      }
    }
  }
}
</style>
