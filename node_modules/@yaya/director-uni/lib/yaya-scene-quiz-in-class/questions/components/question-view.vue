<!-- 图文题干&题干音频组件 -->
<template>
  <view
    :class="[
      'reading_window_dis',
      { r_window_taller: question.category === CATEGORYENUMS.PeomReading },
    ]"
  >
    <view class="r_window_inner">
      <image
        v-if="question.category !== CATEGORYENUMS.PeomReading"
        class="r_w_i_img"
        :src="question.image.url"
      />
      <swiper
        v-else
        class="r_w_i_img"
        :autoplay="false"
        :duration="1000"
        :current="currentQuestion"
      >
        <swiper-item
          catchtouchmove="catchTouchMove"
          v-for="(item, index) in imgList"
          :key="index"
        >
          <image :src="item" />
        </swiper-item>
      </swiper>
      <!-- <image src="https://boxcdn.zuoyebang.cc/v1/zyb-srmp/2dd5f3e0/P2.jpg" /> -->
      <view
        class="r_w_i_scripts inner_script_bottom"
        :class="{ title_witdh: question.title.length > 19 }"
        v-if="
          (question.title && question.category === CATEGORYENUMS.RepeatAfter) ||
            question.category === CATEGORYENUMS.SingleReading
        "
      >
        <view class="flex-text-wrap">
          <view
            class="repeat-text"
            v-if="
              question.title && question.category === CATEGORYENUMS.RepeatAfter
            "
            >{{ question.title.slice(0, 20) || "" }}</view
          >
          <view
            v-else
            class="title_item"
            v-for="item in questionTitleArr"
            :class="{
              item_correct: item.status == 'correct',
              item_wrong: item.status == 'wrong',
            }"
          >
            {{ item.text }}</view
          >
        </view>
      </view>
      <view
        class="r_w_i_scripts inner_script_right"
        v-if="question.category === CATEGORYENUMS.PeomReading"
      >
        <!-- <h6 class="r_title">{{ question.poetry.title || "" }}</h6>
        <p class="r_desc">
          {{ question.poetry.dynasty || "" }} •
          {{ question.poetry.author || "" }}
        </p> -->
        <p class="r_lines" v-for="item in gushiTextArr" :key="item">
          <!-- {{ item.text || "" }} -->
          <span
            class="text_item"
            v-for="(textItem, _idx) in item.text"
            :key="_idx"
            :class="{
              item_correct: textItem.status == 'correct',
              item_wrong: textItem.status == 'wrong',
            }"
          >
            {{ textItem.text || "" }}
          </span>
        </p>
      </view>
    </view>
    <view
      class="audio_icon"
      :class="{ auto_play: audioPlayStatus }"
      @tap="audioTap"
    ></view>
  </view>
</template>

<script>
import { mapState, mapMutations } from "vuex";
import innerAudio from "../js/wxAudioInstance.js";
import { islock } from "../js/lock.js";

export default {
  props: {
    question: {
      type: Object,
      default: {},
    },
    wordStatusChange: {
      type: Object,
      default: {},
    },
    gushiImageChange: {
      type: String,
      default: "",
    },
  },
  watch: {
    wordStatusChange(obj) {
      console.log("监听到wordStatusChange", obj);
      if (obj.type === "PeomReading") {
        // 古诗KTV 替换每一句的文字分数
        // if (obj.changeWordArr.length < this.gushiTextArr[0].text.length) {
        //   obj.changeWordArr = [
        //     ...obj.changeWordArr,
        //     ...[
        //       {
        //         status: "normal",
        //         text: "-",
        //       },
        //     ],
        //   ];
        // }
        console.log("this.gushiTextArr[0]", this.gushiTextArr[0]);
        console.log("this.gushiTextArr", this.gushiTextArr);

        if (
          obj.changeWordArr.length <
          this.gushiTextArr[obj.peomIndex].text.length
        ) {
          let len =
            this.gushiTextArr[obj.peomIndex].text.length -
            obj.changeWordArr.length;
          let arr = [];
          let i = 0;
          for (i; i < len; i++) {
            arr.push({
              status: "normal",
              text: "-",
            });
          }
          obj.changeWordArr = [...obj.changeWordArr, ...arr];
        }
        // this.gushiTextArr = this.gushiTextArr.map((item, index) => {
        //   item.text = item.text.map((textItem, textIndex) => {
        //     if (
        //       textItem.text == obj.changeWordArr[textIndex].text &&
        //       textItem.status != "correct"
        //     ) {
        //       return {
        //         status: obj.changeWordArr[textIndex].status,
        //         text: textItem.text,
        //       };
        //     } else {
        //       return textItem;
        //     }
        //   });
        //   return item;
        // });
        for (let n = 0; n < this.gushiTextArr[obj.peomIndex].text.length; n++) {
          for (let m = 0; m < obj.changeWordArr.length; m++) {
            if (
              this.gushiTextArr[obj.peomIndex].text[n].text ==
                obj.changeWordArr[m].text &&
              this.gushiTextArr[obj.peomIndex].text[n].status != "correct"
            ) {
              this.gushiTextArr[obj.peomIndex].text[n].status =
                obj.changeWordArr[m].status;
            }
          }
        }
        console.log("this.gushiTextArr", this.gushiTextArr);
      } else if (obj.type === "PeomReadingRestart") {
        // 古诗重新开始 替换整首诗的状态为初始态
        this.gushiTextArr = obj.changeWordArr;
      } else if (+this.question.category === 96) {
        // 单句跟读ktv字幕
        // this.questionTitleArr = obj.changeWordArr;
        console.log("this.questionTitleArr", this.questionTitleArr);
        console.log("obj.changeWordArr", obj.changeWordArr);
        if (obj.type === "singleReadingRestart") {
          this.questionTitleArr = obj.changeWordArr;
        } else {
          if (obj.changeWordArr.length < this.questionTitleArr.length) {
            let len = this.questionTitleArr.length - obj.changeWordArr.length;
            let arr = [];
            let i = 0;
            for (i; i < len; i++) {
              arr.push({
                status: "normal",
                text: "-",
              });
            }
            obj.changeWordArr = [...obj.changeWordArr, ...arr];
          }
          // this.questionTitleArr = this.questionTitleArr.map((item, index) => {
          //   if (
          //     item.text == obj.changeWordArr[index].text &&
          //     item.status != "correct"
          //   ) {
          //     item = obj.changeWordArr[index];
          //   } else {
          //     item = item;
          //   }
          //   return item;
          // });
          for (let n = 0; n < this.questionTitleArr.length; n++) {
            for (let m = 0; m < obj.changeWordArr.length; m++) {
              if (
                this.questionTitleArr[n].text == obj.changeWordArr[m].text &&
                this.questionTitleArr[n].status != "correct"
              ) {
                this.questionTitleArr[n].status = obj.changeWordArr[m].status;
              }
            }
          }
        }
        console.log("this.questionTitleArr", this.questionTitleArr);
      }
    },
    gushiImageChange(index) {
      // this.gushiImage = url;
      this.currentQuestion = index;
    },
  },
  data() {
    return {
      questionTitleArr: [],
      gushiTextArr: [],
      gushiImage: "",
      currentQuestion: 0,
      imgList: [],
    };
  },
  computed: {
    ...mapState("quizInClass", [
      "CATEGORYENUMS",
      "audioPlayStatus",
      "recordingStatus",
      "recordRes",
      "step",
    ]),
    imageUrl() {
      return this.gushiImage;
    },
  },
  created() {
    if (+this.question.category === 97) {
      this.gushiImage = this.question.poetry.fields[0].fieldImage.url;
      // 古诗
      this.gushiTextArr = this.question.poetry.fields.map((item, index) => {
        this.imgList.push(item.fieldImage.url);
        item.text = item.text.split("").map((itemText) => {
          return {
            status: "normal",
            text: itemText,
          };
        });
        return item;
      });
    } else {
      this.imgList.push(this.question.image.url);
      let arr = this.question.title.split("");
      this.questionTitleArr = arr.map((item) => {
        return {
          status: "normal",
          text: item,
        };
      });
    }
  },
  methods: {
    ...mapMutations("quizInClass", [
      "updateAudioPlayStatus",
      "updateStep",
      "updateRecordingStatus",
    ]),
    // 题干音频播放按钮
    audioTap() {
      console.log("题干音频按钮点击");
      if (islock("audioTap")) {
        return;
      }
      setTimeout(() => {
        // 延迟500ms开始音频播放 留出一定时间结束当前播放的音频
        innerAudio.playAudio();
      }, 500);
      // todo 点击播放按钮重新开始答题
      this.updateRecordingStatus(false);
      this.innerAudioContext.destroy();
      this.$emit("reset", "stop");
    },
    catchTouchMove() {
      return false;
    },
  },
};
</script>

<style lang="scss" scoped>
@import "../../../static/css/mixin.scss";
@import "../../../static/css/yaya-mixin.scss";
.reading_window_dis {
  @include normalStyle(
    tovmin(916),
    tovmin(366),
    $colorGray,
    $colorWhite,
    tovmin(24)
  );
  @extend .posCenter;
  top: 55%;
  $topH: tovmin(100);
  margin-top: -#{$topH};
  &.r_window_taller {
    @include normalStyle(
      tovmin(916),
      tovmin(400),
      $colorGray,
      $colorWhite,
      tovmin(24)
    );
    .r_window_inner {
      @include WH(tovmin(898), tovmin(382));
      border-radius: tovmin(20);
      .r_w_i_img {
        @include WH(tovmin(898), tovmin(382));
        image {
          @include WH(tovmin(898), tovmin(382));
        }
      }
    }
  }
  .r_window_inner {
    @extend .posCenter;
    /* @include WH(tovmin(898), tovmin(348)); */
    @include WH(tovmin(900), tovmin(350));
    border-radius: tovmin(20);
    overflow: hidden;
    image.r_w_i_img {
      /* @include WH(tovmin(898), tovmin(349)); */
      @include WH(tovmin(900), tovmin(350));
    }
    .r_w_i_scripts {
      @include normalStyle(
        /* tovmin(480), */ auto,
        tovmin(60),
        $colorWhite,
        rgba(0, 0, 0, 0.6),
        tovmin(30)
      );
      &.inner_script_bottom {
        /* max-width: 19em; */
        max-width: tovmin(720);
        /* width: auto; */
        height: tovmin(56);
        overflow: auto;
        position: absolute;
        @extend .posCenter;
        top: tovmin(296);
        bottom: tovmin(-20);
        padding: 0 tovmin(40);
        font-weight: 600;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        text-align: center;
        box-sizing: border-box;
        .inner_script_bottom:after {
          content: "";
          display: block;
          width: 0px;
          height: 100%;
          border-right: 1px solid transparent;
        }
        &.title_witdh {
          width: tovmin(720);
        }
        .flex-text-wrap {
          display: flex;
          box-sizing: border-box;
          /* justify-content: space-between; */
          justify-content: center;
          width: 100%;
          overflow: auto;
          align-items: center;
          .repeat-text {
            white-space: nowrap;
          }
          .title_item {
            /* flex: 0 0 20%; */
            /* margin-right: 10px; */
            flex-grow: 0;
            display: inline-block;
            font-size: tovmin(32);
            width: tovmin(32);
            height: tovmin(56);
            line-height: tovmin(56);
            text-align: center;
            /* float: left; */
            &.item_correct {
              color: #c1ff3a;
            }
            &.item_wrong {
              color: #ffaa00;
            }
          }
        }
      }
      &.inner_script_right {
        position: absolute;
        top: tovmin(12);
        right: tovmin(12);
        /* width: tovmin(360); */
        min-width: tovmin(360);
        height: tovmin(358);
        background: rgba(0, 0, 0, 0.6);
        border-radius: tovmin(16);
        font-weight: 600;
        overflow: auto;
        .r_title {
          margin-top: tovmin(30);
          font-size: tovmin(36);
          line-height: tovmin(36);
        }
        .r_desc {
          margin-top: tovmin(16);
          font-size: tovmin(26);
          line-height: tovmin(33);
        }
        .r_lines {
          margin-top: tovmin(15);
          padding-left: 1.2em;
          font-size: tovmin(32);
          line-height: tovmin(40);
          letter-spacing: tovmin(10);
          .text_item {
            display: inline-block;
            &.item_correct {
              color: #c1ff3a;
            }
            &.item_wrong {
              color: #ffaa00;
            }
          }
        }
        .r_lines:first-child {
          font-size: tovmin(36);
          margin-top: tovmin(30);
          line-height: tovmin(36);
        }
        .r_lines:nth-child(2) {
          font-size: tovmin(26);
          margin-top: tovmin(16);
          line-height: tovmin(33);
        }
      }
    }
  }
  .audio_icon {
    @include circle_view(91);
    background: url("https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-choice/audio_flash.png")
      no-repeat;
    background-size: auto 100%;
    background-position-x: 100%;
    position: absolute;
    left: tovmin(-37);
    top: 50%;
    transform: translate3d(0, -50%, 0);
    &.auto_play {
      animation: horn-animation 1.2s steps(2, end) infinite;
    }
  }
}
@keyframes horn-animation {
  0% {
    background-position-x: 0;
  }
  50% {
    background-position-x: 100%;
  }
  100% {
    background-position-x: 100%;
  }
}
</style>
