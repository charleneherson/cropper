<template>
  <view :id="getId(question.category)">
    <view
      class="reading_box"
      :style="{ transform: IS_IPAD ? 'scale(.7,.7)' : 'scale(1)' }"
      :class="[
        {
          single_reading:
            question.category === CATEGORYENUMS.SingleReading ||
            question.category === CATEGORYENUMS.PeomReading,
          repeat: question.category === CATEGORYENUMS.RepeatAfter,
        },
      ]"
    >
      <!-- <view class="bg_left"></view>
      <view class="bg_right"></view> -->
      <view class="swiper-item">
        <!-- 题干&题干音频组件 -->
        <question-view
          :question="question"
          :wordStatusChange="wordStatusChange"
          :gushiImageChange="gushiImageChange"
          @reset="resetActions"
        />
        <!-- 录音按钮组件 -->
        <record-button
          ref="recordButton"
          :question="question"
          :isPad="IS_IPAD"
          @submit="submit"
          @changeWord="changeWord"
          @gushiChange="gushiChange"
          :clearCountDown="clearCountDown"
        />
        <!-- 序号  -->
        <serial-number
          v-if="step != STEPENUMS.Check"
          class="reading_serial_number"
          :serialData="{ current: index + 1, total: tatoal }"
        />
        <!-- 回听&提交蒙层  -->
        <record-complete
          v-if="step === STEPENUMS.Check"
          @reset="resetActions"
          @submit="submit"
        />
      </view>
    </view>
  </view>
</template>

<script>
import { mapState, mapMutations } from "vuex";
import vSdk from "./js/audioSdkInstance.js";
import SerialNumber from "./../../yaya-common/components/serial-number/index.vue";
import RecordComplete from "./components/record-complete.vue";
import RecordButton from "./components/record-button.vue";
import QuestionView from "./components/question-view.vue";

export default {
  name: "Reading",
  data() {
    return {
      countTimer: null, // 设置 定时器 初始为null
      boundaryScore: 80, // 分界分数
      clearCountDown: {
        status: false,
        type: "",
      }, // 清除canvas圆环倒计时
      wordStatusChange: {},
      gushiImageChange: 0,
      readingAudioContextOnPlay: false,
    };
  },
  props: {
    question: {
      type: Object,
      default: {},
    },
    index: {
      type: Number,
      default: 0,
    },
    currentIndex: {
      type: Number,
      default: 0,
    },
    tatoal: {
      type: Number,
      default: 0,
    },
    isPause: {
      type: Object,
      default: {
        status: false,
        params: "",
      },
    },
    canStart: {
      type: Boolean,
      default: false,
    },
  },
  computed: {
    ...mapState("quizInClass", [
      "CATEGORYENUMS",
      "STEPENUMS",
      "audioPlayStatus",
      "recordingStatus",
      "recordRes",
      "step",
    ]),
    ...mapState("yayaCommon", ["IS_IPAD", "SYSTEM_INFO"]),
  },
  watch: {
    currentIndex(val) {
      console.log("currentIndexcurrentIndex", val);
      console.log("this.index  this.index", this.index);
      console.log("this.isPause  this.isPause", this.isPause);
      clearTimeout(this.readingTimer);
      if (val === this.index) {
        if (!this.isPause.status) {
          console.log("watch到currentIndex变化");
          if (this.isStart) {
            this.resetActions();
          } else {
            this.startAction();
            this.restart();
          }
        }
      }
    },
    isPause(val) {
      console.log("val val   val  val", val);
      console.log("this.index this.index this.index", this.index);
      console.log("this.isStart this.isStart this.isStart", this.isStart);
      // val.status 为 true 出现蒙层  选择确认离开还是继续学习   val.status 为 false  是点击继续学习
      if (!val.status && this.currentIndex === this.index) {
        //  点击继续学习，蒙层消失 从头开始答题
        console.log("点击继续学习，蒙层消失 从头开始答题");
        if (this.isStart) {
          this.resetActions();
        } else {
          this.startAction();
          this.restart();
        }
      }
      if (val.status && this.currentIndex === this.index) {
        //  出现蒙层应该暂停所有播放的语音
        console.log("出现蒙层应该暂停所有播放的语音");
        if (val.params != "openAnimation") {
          this.clearCountDown = {
            clearCountDown: !this.clearCountDown.status,
            type: "stop",
          };
        }
        this.readingAudioContext && this.readingAudioContext.stop();
      }
    },
    canStart(val) {
      console.log("canStartcanstart", val);
      this.canStart = val;
      if (val && this.currentIndex === this.index) {
        this.startAction();
        this.restart();
      }
    },
  },
  components: {
    SerialNumber,
    RecordComplete,
    RecordButton,
    QuestionView,
  },
  created() {
    console.log("this.canStart", this.canStart);
    this.readingAudioContext = wx.createInnerAudioContext();
    if (this.canStart && this.currentIndex === this.index) {
      this.startAction();
    }
  },
  mounted() {},
  methods: {
    ...mapMutations("quizInClass", [
      "updateAudioPlayStatus",
      "updateRecordingStatus",
      "updateStep",
    ]),

    startAction() {
      this.isStart = true;
      clearInterval(this.countTimer);
      console.log(`startAction[阅读类题型] Created!!! `, this.question);
      this.readingAudioContext.onPlay(() => {
        console.log(
          `[阅读类题型]开始播放... step=${this.step}, category=${this.question.category}`
        );
        this.readingAudioContextOnPlay = true;
        this.updateAudioPlayStatus(true);
        if (this.step == this.STEPENUMS.Start) {
          // this.updateStep(this.STEPENUMS.Listen);
          if (!this.CATEGORYENUMS.PeomReading) {
            this.updateStep(this.STEPENUMS.Listen);
          }
        }
      });
      this.readingAudioContext.onEnded((res) => {
        console.log("this.readingAudioContext.onEnded");
        this.updateAudioPlayStatus(false);
        // 题干播放结束，触发录音按钮组件 录音事件
        if (this.readingAudioContextOnPlay) {
          this.$refs.recordButton._audioEnd();
        }
      });

      this.readingAudioContext.onError((res) => {
        console.log("this.readingAudioContext.onError", res);
      });
    },

    /** 创建题型Id */
    getId(category) {
      return `reading_type_${category}`;
    },

    // 最终完成答题，提交音频文件
    submit(val) {
      console.log(
        `组件内调用提交Submit/作答记录... score:${this.recordRes.score}`
      );

      let self = this;
      if (val === "complete") {
        this.updateStep(self.STEPENUMS.Test);
      }
      this.$emit(
        "remark",
        this.recordRes.score >= this.boundaryScore
          ? ["first", "reading"]
          : ["notFirst", "reading"]
      );

      /**提交接口数据 */
      const userKv = {
        duration: this.recordRes.length_ms,
        beginTime: new Date().getTime(),
        tid: this.question.tid,
      };

      const answerData = {};
      // 提交
      if (this.question.category == this.CATEGORYENUMS.PeomReading) {
        // 古诗
        console.log(
          `[调用] wx.uploadFile, data:`,
          self.recordRes.online_audio_url
        );
        wx.uploadFile({
          url: "https://yuwen.zybang.com/kid-chinese/inclass/audioupload",
          // url:
          //   "http://kidaction-docker.suanshubang.com/kid-chinese/inclass/audioupload",
          filePath: self.recordRes.online_audio_url,
          name: "audioFile",
          header: {
            "content-type": "multipart/form-data",
          },
          success: function(res) {
            console.log(`SDK uploadFile Successssss`, res);
            const data = JSON.parse(res.data);
            console.log(`SDK uploadFile Success Data Data: `, data);
            answerData[self.question.tid] = {
              answer: {
                record: data.data.url, // 跟读音频文件
                score: 90,
              },
              duration: self.recordRes.length_ms,
              isSign: 1,
              userKv: {},
            };

            let DataSubmit = {
              type: self.question.category,
              answerData: answerData,
              userKv: userKv,
              first: self.recordRes.score >= self.boundaryScore ? 1 : 0,
            };

            /*作答记录接口数据*/
            let submitObj = {
              type: self.question.category,
            };
            const answerInfo = {
              tidId: self.question.tid,
              tidType: self.question.category,
              isCorrect: 1,
            };
            answerInfo.answerData = answerData;
            submitObj.answerData = answerInfo;

            let resData = {
              DataSubmit: DataSubmit,
              submitObj: submitObj,
            };
            console.log(`SDK 组件内调用提交... ${JSON.stringify(resData)}`);

            vSdk.destroySdk();
            self.$emit("gotRecordResult", resData);
          },
          fail: function(res) {
            if (res) {
              console.log(`SDK uploadFile fail`, res);
            }
          },
          complete: function(res) {
            console.log(`SDK uploadFile complete`, res);
            if (res) {
            }
          },
        });
      } else {
        // 单句跟读和开放口述
        answerData[this.question.tid] = {
          answer: {
            record: this.recordRes.online_audio_url, // 跟读音频文件
            score: this.recordRes.score,
          },
          duration: this.recordRes.length_ms,
          isSign: 1,
          userKv: {},
        };

        let DataSubmit = {
          type: this.question.category,
          answerData: answerData,
          userKv: userKv,
          first: self.recordRes.score >= self.boundaryScore ? 1 : 0,
        };

        /*作答记录接口数据*/
        let submitObj = {
          type: this.question.category,
        };
        const answerInfo = {
          tidId: this.question.tid,
          tidType: this.question.category,
          isCorrect: 1,
        };
        answerInfo.answerData = answerData;
        submitObj.answerData = answerInfo;

        let res = {
          DataSubmit: DataSubmit,
          submitObj: submitObj,
        };
        console.log(`组件内调用提交... ${JSON.stringify(res)}`);

        vSdk.destroySdk();
        self.$emit("gotRecordResult", res);
      }
    },

    // 重置答题状态
    resetActions(isStop) {
      console.log("监听到重置按钮点击 重新开始答题", isStop);
      console.log("this.currentIndex", this.currentIndex);
      console.log("this.index", this.index);
      console.log("this.recordingStatus", this.recordingStatus);
      // this.recordingStatus && vSdk.stop();
      vSdk.destroySdk();
      this.readingAudioContext && this.readingAudioContext.stop();
      this.readingAudioContext.src = this.question.audio.url;
      this.updateAudioPlayStatus(false);
      this.updateRecordingStatus(false);
      this.updateStep(this.STEPENUMS.Start);
      if (this.currentIndex === this.index) {
        console.log(
          "this.clearCountDownthis.clearCountDown",
          this.clearCountDown
        );
        let ddd = {
          status: !this.clearCountDown.status,
          type: isStop == "stop" ? "stop" : "",
        };
        this.clearCountDown = ddd;
        console.log(
          "this.clearCountDownthis.clearCountDown",
          this.clearCountDown
        );
        this.restart();
      }
    },

    // 重新开始答题
    restart() {
      console.log("重新开始答题restart");
      let value96 = wx.getStorageSync("openAnimation96");
      let value97 = wx.getStorageSync("openAnimation97");
      if (+this.question.category === 96) {
        if (value96) {
          console.log("缓存有openAnimation96  不展示开场动画");
        } else {
          console.log("restart  展示开场动画");
          return;
        }
      }
      if (+this.question.category === 97) {
        if (value97) {
          console.log("缓存有openAnimation97  不展示开场动画");
        } else {
          console.log("restart  展示开场动画");
          return;
        }
      }
      this.updateStep(this.STEPENUMS.Start);
      clearInterval(this.countTimer);
      this.readingAudioContext = wx.createInnerAudioContext();
      this.readingAudioContext.src = this.question.audio.url;
      this.readingAudioContext.onCanplay(() => {
        this.readingAudioContext.play();
        this.readingAudioContext.offCanplay();
      });
      // // if (this.SYSTEM_INFO.indexOf("iOS") < 0) {
      //   // console.log("android");
      //   this.readingAudioContext.onCanplay(() => {
      //     console.log("canplaycanplaycanplaycanplaycanplay");
      //     this.readingAudioContext.play();
      //     this.readingAudioContext.offCanplay();
      //   });
      // } else {
      //   // console.log("ios");
      //   // onCanplay这个API在ios上有官方bug  再次更改src的时候不能触发  满足不了重新答题的需求 只能手动添加延迟
      //   setTimeout(() => {
      //     this.readingAudioContext.play();
      //   }, 800);
      // }
      // 把文字状态更新成默认状态
      if (+this.question.category === 97) {
        // 古诗
        if (this.question.poetry.fields[0].text[0].status) {
          this.wordStatusChange = {
            changeWordArr: this.question.poetry.fields,
            type: "PeomReadingRestart",
          };
        } else {
          let gushiTextArr = this.question.poetry.fields.map((item, index) => {
            item.text = item.text.split("").map((itemText) => {
              return {
                status: "normal",
                text: itemText,
              };
            });
            return item;
          });
          this.wordStatusChange = {
            changeWordArr: gushiTextArr,
            type: "PeomReadingRestart",
          };
        }
        this.gushiImageChange = 0;
      } else {
        let arr = this.question.title.split("");
        console.log("重新答题  单句跟读arr", arr);
        let questionTitleArr = arr.map((item) => {
          return {
            status: "normal",
            text: item,
          };
        });
        console.log("重新答题  单句跟读questionTitleArr", questionTitleArr);
        this.wordStatusChange = {
          changeWordArr: questionTitleArr,
          type: "singleReadingRestart",
        };
      }
      this.startAction();
    },

    // 监听到文字分数变化
    changeWord(obj) {
      console.log("reading监听到文字分数变化  changeWord", obj);
      this.wordStatusChange = obj;
    },

    // 监听到古诗句子变化
    gushiChange(index) {
      this.gushiImageChange = index;
    },
  },
};
</script>

<style lang="scss" scoped>
@import "../../static/css/yaya-mixin.scss";
.reading_box {
  width: 100vw;
  height: 100vh;
  /* background: $bgColor_2; */
  background-size: 100vw 100vh;
  .is_pad {
    transform: scale(0.7, 0.7);
  }
  &.repeat {
    .bg_left {
      height: 100vh;
      width: tovmin(641);
      position: absolute;
      left: 0;
      bottom: 0;
      background: url("https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/icons/bg_left_4_repeat.png")
        0 0 no-repeat;
      background-size: cover;
    }

    .bg_right {
      height: 100vh;
      width: tovmin(491);
      position: absolute;
      right: 0;
      bottom: 0;
      background: url("https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/icons/bg_right_4_repeat.png")
        0 0 no-repeat;
      background-size: cover;
    }
  }
  &.single_reading {
    /* background: $bgColor; */
    .bg_left {
      height: 100vh;
      width: tovmin(521);
      position: absolute;
      left: 0;
      bottom: 0;
      background: url("https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/icons/bg_left_4_reading.png")
        0 0 no-repeat;
      background-size: cover;
    }
    .bg_right {
      height: tovmin(335);
      width: tovmin(533);
      position: absolute;
      right: 0;
      bottom: 0;
      background: url("https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/icons/bg_right_4_reading.png")
        0 0 no-repeat;
      background-size: cover;
    }
  }
}
</style>
