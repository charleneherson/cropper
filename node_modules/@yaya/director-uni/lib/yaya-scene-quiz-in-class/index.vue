<!-- 2020-03-24  语文-课中练习-场景  -->
<template>
  <view
    class="scene"
    :class="{
      isopen: scene.data.ext.questionList[currentIndex].category == 95,
    }"
    v-if="scene && scene.data && scene.data.ext"
  >
    <view v-if="showLayer" class="sence-change"></view>
    <view
      class="bg_left"
      :class="{
        isopen: scene.data.ext.questionList[currentIndex].category == 95,
      }"
    ></view>
    <view
      class="bg_right"
      :class="{
        isopen: scene.data.ext.questionList[currentIndex].category == 95,
      }"
    ></view>
    <!-- start 阅读类题型 -->
    <view v-if="showOpenAnimation" class="openAnimationwrap">
      <view class="light left"></view>
      <view class="light right"></view>
      <view class="animationContainer"></view>
    </view>
    <swiper
      class="swiper"
      :indicator-dots="false"
      :autoplay="false"
      :current="currentIndex"
      @animationfinish="animationfinish"
      @change="onchange"
    >
      <swiper-item
        :class="[
          { single_reading: question.category === CATEGORYENUMS.SingleReading },
        ]"
        v-for="(question, index) in scene.data.ext.questionList"
        :key="question.tid"
        catchtouchmove="stopTouchMove"
      >
        <QItem
          v-if="IsReadingType(question.category)"
          :question="question"
          :index="index"
          :currentIndex="currentIndex"
          :isPause="pauseAudioAndRecord"
          :tatoal="scene.data.ext.questionList.length"
          :canStart="canStart"
          @gotRecordResult="gotRecordResult"
          @remark="remark"
        />
      </swiper-item>
    </swiper>
    <RemarkMask
      v-if="remarkMaskType.maskType"
      @maskAnimationend="maskAnimationend"
      :maskType="remarkMaskType.maskType"
    />
  </view>
</template>
<script>
import { mapState, mapMutations } from "vuex";
import yayaScene from "../yaya-scene/yaya-scene.vue";
import QItem from "./questions/Reading.vue";
import RemarkMask from "../yaya-common/components/mask/mask";

export default {
  name: "yayaSceneQuiz",
  // 扩展场景基类（vue的extends好菜，vue+uniapp+mp）
  extends: yayaScene,
  components: {
    QItem,
    RemarkMask,
  },
  props: {},
  data() {
    return {
      currentIndex: 0,
      pauseAudioAndRecord: {
        status: false,
        params: "",
      },
      remarkMaskType: {},
      showOpenAnimation: false,
      canStart: false,
      showLayer: false,
      isOpenAniFun: false,
    };
  },
  computed: {
    ...mapState("quizInClass", ["TYPE", "STEPENUMS", "CATEGORYENUMS", "step"]),
  },
  methods: {
    ...mapMutations("quizInClass", ["updateStep"]),
    onchange(res) {
      this.canStart = false;
      this.currentIndex = res.detail.current;
      this.controlOpenAnimation();
    },
    stopTouchMove() {
      return false;
    },
    animationfinish(val) {
      this.updateStep(this.STEPENUMS.Start);
      console.log(`animationfinish  `, val);
      const { detail } = val;
      this.currentIndex = detail.current;
      this.$nextTick(() => {
        setTimeout(() => {
          this.showLayer = false;
        }, 500);
      });
    },
    /**语音类题型结果输出 */
    gotRecordResult(res) {
      console.log(`[Anwsered] 阅读类题型-触发业务页面提交-------------->`, res);
      this.interact("anwsered", res.DataSubmit);
      this.interact("anwserRecord", res.submitObj);
    },
    changeScene() {
      console.log(`[Anwsered] 阅读类题型-切换场景-------------->`);
      this.showLayer = true;
      if (this.currentIndex === this.scene.data.ext.questionList.length - 1) {
        console.log("this.scene.actions.success", this.scene.actions.success);
        this.$emit("act", this.scene.actions.success);
        return;
      } else {
        console.log("this.currentIndex++", this.currentIndex);
        this.currentIndex++;
      }
    },
    IsReadingType(type) {
      return this.TYPE.TypeReading.indexOf(type) > -1;
    },
    remark(type) {
      console.log(`Remark Executed `, type);
      this.remarkMaskType = {
        isMask: type !== "",
        maskType: type,
      };
    },
    maskAnimationend() {
      console.log(`[Respone结束] `);
      this.remarkMaskType = {
        isMask: "",
        maskType: "",
      };
      this.changeScene();
    },
    controlOpenAnimation() {
      this._openAnimationAudio && this._openAnimationAudio.stop();
      // 开场动画 只展示一次
      try {
        let value96 = wx.getStorageSync("openAnimation96");
        let value97 = wx.getStorageSync("openAnimation97");
        if (
          this.scene.data.ext.questionList[this.currentIndex].category == 95
        ) {
          // 开放口述不展示开场动画 直接跳过
          this.canStart = true;
          return;
        }
        if (
          this.scene.data.ext.questionList[this.currentIndex].category == 96 ||
          this.scene.data.ext.questionList[this.currentIndex].category == 97
        ) {
          // 单句跟读和古诗题展示开场动画
          if (
            this.scene.data.ext.questionList[this.currentIndex].category == 96
          ) {
            if (value96) {
              console.log("缓存有openAnimation96  不展示开场动画");
              this.canStart = true;
            } else {
              this.canStart = false;
              wx.setStorageSync("openAnimation96", true);
              this.openAniFun();
            }
          }
          if (
            this.scene.data.ext.questionList[this.currentIndex].category == 97
          ) {
            if (value97) {
              // if (false) {
              console.log("缓存有openAnimation97  不展示开场动画");
              this.canStart = true;
            } else {
              this.canStart = false;
              wx.setStorageSync("openAnimation97", true);
              this.openAniFun();
            }
          }
        }
      } catch (e) {
        // Do something when catch error
      }
    },
    openAniFun() {
      this.showOpenAnimation = true;
      this._openAnimationAudio.play();
      this.isOpenAniFun = true;
      this._openAnimationAudio.onEnded(() => {
        if (this.isOpenAniFun) {
          // 开场动画的语音播放完毕
          console.log("开场动画的语音播放完毕");
          setTimeout(() => {
            // 产品要求语音播放结束后一秒关闭动画
            this.showOpenAnimation = false;
            this.isOpenAniFun = false;
            this.canStart = true;
          }, 1000);
        }
      });
    },
  },
  created() {
    console.log("this.scene", this.scene);
    this._openAnimationAudio = wx.createInnerAudioContext();
    this._openAnimationAudio.autoplay = false;
    this._openAnimationAudio.src =
      "https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-audio/openAnimationAudio.mp3";
  },
  mounted() {
    this.scene.onPause((payload) => {
      if (payload.isIntercepted) {
        // 暂停你的场景，停止音频、视频的播放，停止录音
        console.log(`暂停你的场景----------->`);
        this.pauseAudioAndRecord.status = true;
        if (this.showOpenAnimation) {
          // 如果正在播放开场动画 就把开场动画暂停掉
          this.showOpenAnimation = false;
          this._openAnimationAudio.stop();
          this.pauseAudioAndRecord.params = "openAnimation";
        }
      }
    });
    this.scene.onResume((payload) => {
      // 恢复你的场景
      console.log(`恢复你的场景----------->`);
      this.pauseAudioAndRecord.status = false;
    });
    this.scene.onStart(() => {
      this.canStart = false;
      this.start();
      this.pauseAudioAndRecord.status = false;
      this.controlOpenAnimation();
    });
  },
};
</script>
<style lang="scss" scoped>
@import "../static/css/mixin.scss";
@import "../static/css/yaya-mixin.scss";
.scene {
  width: 100vw;
  height: 100vh;
  background-color: $bgColor;
  .sence-change {
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0);
    position: fixed;
    left: 0;
    top: 0;
    z-index: 100;
  }
  .bg_left {
    height: 100vh;
    width: tovmin(641);
    position: absolute;
    left: 0;
    bottom: 0;

    background: url("https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/icons/bg_left_4_reading.png")
      0 0 no-repeat;
    background-size: 100% 100%;
    &.isopen {
      background: url("https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/icons/bg_left_4_repeat.png")
        0 0 no-repeat;
      background-size: 100% 100%;
    }
  }
  .bg_right {
    height: 100vh;
    width: tovmin(491);
    position: absolute;
    right: 0;
    bottom: 0;

    background: url("https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/icons/bg_right_4_reading.png")
      0 0 no-repeat;
    background-size: 100% 100%;
    &.isopen {
      background: url("https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/icons/bg_right_4_repeat.png")
        0 0 no-repeat;
      background-size: 100% 100%;
    }
  }
  .swiper {
    height: 100%;
    .swiper-item {
    }
  }
  &.isopen {
    background-color: $bgColor_2;
  }
  .openAnimationwrap {
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    position: fixed;
    top: 0;
    z-index: 999;
    .animationContainer {
      width: tovmin(300);
      height: tovmin(510);
      /* width: 150px;
      height: 255px; */
      background: url("https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-common/newOpenAnimationSprites.png")
        no-repeat;
      background-size: cover;
      animation-fill-mode: forwards;
      animation: open-animation 1s steps(14) 0.3s infinite,
        open-animation-popup 0.3s 1;
      position: absolute;
      /* left: tovmin(520); */
      left: 50%;
      bottom: tovmin(80);
      transform: translate(-50%, 0);
    }
    .light {
      width: tovmin(286);
      height: tovmin(452);
      background-size: 100% 100%;
      position: absolute;
      top: tovmin(-113);
      animation: open-animation-light-down 0.5s steps(29) 0.5s 1;
      &.left {
        left: tovmin(527);
        background-image: url("https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-common/openAnimationLightLeft.png");
        animation: open-animation-light-left 6.5s ease-in 1s infinite;
        transform-origin: tovmin(51) tovmin(113);
      }
      &.right {
        background-image: url("https://zyb-yayayuwen-1253445850.cos.ap-beijing.myqcloud.com/yaya-fe/sdk-media/yaya-common/openAnimationLightRight.png");
        right: tovmin(527);
        animation: open-animation-light-right 6.5s ease-in 1s infinite;
        transform-origin: tovmin(234) tovmin(113);
      }
    }
  }
  @keyframes open-animation {
    0% {
      background-position-x: 0;
    }
    100% {
      background-position-x: 100%;
    }
  }
  @keyframes open-animation-popup {
    0% {
      bottom: tovmin(-600);
    }
    100% {
      bottom: tovmin(80);
    }
  }
  @keyframes open-animation-light-down {
    0% {
      top: tovmin(-500);
    }
    100% {
      top: tovmin(-113);
    }
  }
  @keyframes open-animation-light-left {
    0% {
      left: tovmin(527);
      transform: rotate(0deg);
    }
    50% {
      left: tovmin(1000);
      transform: rotate(45deg);
    }
    100% {
      left: tovmin(527);
      transform: rotate(0deg);
    }
  }
  @keyframes open-animation-light-right {
    0% {
      right: tovmin(527);
      transform: rotate(0deg);
    }
    50% {
      right: tovmin(1000);
      transform: rotate(-45deg);
    }
    100% {
      right: tovmin(527);
      transform: rotate(0deg);
    }
  }
}
</style>
