
import tools from '../../../utils/tool'
import { NOT_FOUND } from '../../../utils/statusCode'

// 计数器
let callbackCount = 0

/**
 *Cef invoke
 *fe通过cef方式触发win端操作,返回promise对象
 * @export
 * @param {object} [options={}]
 *  @property {string} method  触发端的action名字
 *  @property {object} data    参数
 * @returns
 */
export function invoke (options: any = {}) {
  return new Promise((resolve, reject) => {
    if (typeof window.ZCefClient === 'undefined') {
      reject(new Error('there no define zcef.'))
      return
    }
    // 解析参数
    const { method, data } = options
    if (!method) {
      reject(new Error('method is undefined.'))
      return
    }
    // invoke parameters
    let params: any = {
      callback: `__cb__${tools.guid()}__${callbackCount++}`
    }

    // 包装回调函数
    function _hanlderCallback (res: any) {
      if (res.code === NOT_FOUND) {
        reject(res)
      } else {
        resolve(res)
      }
      // 移除监听
      window.ZCefClient.removeEventListener(params.callback)
    }

    if (data) {
      params['parameters'] = data
    }
    // 监听触发结果
    window.ZCefClient.addEventListener(params.callback, _hanlderCallback)
    // 触发
    window.ZCefClient.invokeMethod(method, data)
  })
}
